250624
heal 로직 바꿈 (endo>histo)
pacl 만들 때 EMRID에 의해 join되도록.

# 퇴장
```{r}
set.seed(1234)
while (TRUE) {
  # result <- 1 + 1
  # print(result)
  print(format(Sys.time(),"%y-%m-%d-%H-%M"))
  Sys.sleep(100)  # 100초 대기
}
```

```{r}
#데이터 다루기, 통계
library(readxl)
library(dplyr) #%>%
library(tidyr)
library(rstatix)   # Grubbs 테스트 등
library(EnvStats)  # Grubbs 테스트 등 (필요 시)
library(broom)  # tidy(), glance() 등을 통해 모델 결과를 data.frame으로 쉽게 추출
library(car) # leveneTest(y ~ group)
library(stringr)

library(Seurat) # SCT normalzation, clustering

#그림그리기
library(ggplot2)
library(pheatmap) #pheatmap
library(grid) #grid.text로 범례 추가
library(Hmisc) #rcorr
library(ComplexHeatmap) #Heatmap, Legend, draw
library(circlize) #colorRamp라는 요소
```

# load & metadata joining
```{r}
mibd=read_xlsx("/data/kjc1/projects/#124. mIBD/Initial Dataset_merged.xlsx",sheet="BioProbeCountMatrix")
mibd_meta_raw=read_xlsx("/data/kjc1/projects/#124. mIBD/Initial Dataset_merged.xlsx",sheet="SegmentProperties")
mibd_meta_patho=read_xlsx("/data/kjc1/projects/#124. mIBD/20250116 UC 치료전후생검 GeoMx TMA-샘플 매칭 리스트_trim.xlsx")
# mibd_meta_clinical=read_xlsx("/data/kjc1/projects/#124. mIBD/1. biologics naive 이름_병록번호 제외_trim_EMRID.xlsx")%>%
#   .[!names(.)%in%c("treatment", "slide","TMA 순번")]
mibd_meta_clinical=read_xlsx("/data/kjc1/projects/#124. mIBD/1. biologics naive 이름_병록번호 제외_trim_EMRID_ust추가.xlsx")%>%
  .[!names(.)%in%c("treatment", "slide","TMA 순번")]

mibd_meta_pacl=mibd_meta_patho%>%
  left_join(mibd_meta_clinical, by=c("병리번호"="병리번호"))

mibd_meta_pacl=mibd_meta_patho%>%
  left_join(mibd_meta_clinical, by=c("병록번호"="EMRID"))

mibd_meta=mibd_meta_raw%>%
  mutate(ROILabel=as.numeric(ROILabel))%>%
  left_join(mibd_meta_pacl, by=c("ROILabel"="TMA 순번","set"="set"))

raw_data=mibd
SP=mibd_meta
sp=SP%>%
#  .[.$treat=="pre",]%>%
  .[!is.na(.$`mucosal healing`),]
rownames(sp)=sp$SegmentDisplayName
```

# library, function
```{r}



findMarkersLike <- function(data_norm, SP, factor1 = "Keloid",factor2=NULL,
                            test_method = c("t.test", "wilcox.test"),threshold=0) {
  
  test_method <- match.arg(test_method)
  
  # factor_col 열에서 "True"/"False" 변환
  group_info <- SP[[factor1]]
  # 문자열 "True"/"False"를 논리형으로 변환(또는 factor로 변환)
  group_info <- as.logical(group_info)
  if(is.null(factor2)){
    group_info2=!group_info
  }else{
    group_info2=SP[[factor2]]
    group_info2 <- as.logical(group_info2)
    group_info2=!group_info&group_info2
  }
  
  results_list <- lapply(rownames(data_norm), function(gene_name) {
    
    # gene_name에 대한 두 그룹 분리
    expr_true  <- as.numeric(data_norm[gene_name, group_info])
    expr_false <- as.numeric(data_norm[gene_name, group_info2])
    
    # 해당 gene에 대한 테스트
    if(test_method == "t.test") {
      test_res <- t.test(expr_true, expr_false)
    } else {
      test_res <- wilcox.test(expr_true, expr_false)
    }
    
    # 평균 계산
    mean_true  <- mean(expr_true)
    mean_false <- mean(expr_false)
    
    # log2 FC (필요시 pseudo-count 추가)
    if(mean_true==0){mean_true=1e-6}
    if(mean_false==0){mean_false=1e-6}
    log2fc <- log2((mean_true) / (mean_false))
    
    # 각 그룹에서 0보다 큰 값(혹은 특정 기준치)을 가진 샘플 비율
    pct_true  <- sum(expr_true > threshold) / length(expr_true)
    pct_false <- sum(expr_false > threshold) / length(expr_false)
    
    data.frame(
      gene        = gene_name,
      p_val       = test_res$p.value,
      avg_log2FC  = log2fc,
      pct.1       = pct_true,
      pct.2       = pct_false,
      mean_true   = mean_true,
      mean_false  = mean_false
    )
  })
  
  results_df <- do.call(rbind, results_list)
  
  # 다중비교 보정
  results_df$p_val_adj <- p.adjust(results_df$p_val, method = "BH")
  
  # rownames -> gene으로 이미 표시했으므로 rownames 없음
  rownames(results_df) <- NULL
  
  return(results_df)
}

# p-value를 기호로 변환하는 함수 정의
pval_to_stars <- function(p) {
  if (is.na(p)) return(NA)       # NA 값 처리
  else if (p < 0.001) return("***")
  else if (p < 0.01) return("**")
  else if (p < 0.05) return("*")
  else return("")
}

```


# automation
```{r}

# raw_data <- read_excel(
#   path = dir_excel,
#   sheet = "BioProbeCountMatrix"
# )

rownames(raw_data)=raw_data$ProbeDisplayName

# SP <- read_excel(
#   path = dir_excel, 
#   sheet = "SegmentProperties"
# )

rownames(SP)=SP$SegmentDisplayName


data_selected <- raw_data %>%
  dplyr::select(
    `ProbeDisplayName`,
    `TargetName`,
    `HUGOSymbol`,
    matches("\\|")  # 파이프(|) 문자 포함된 컬럼명, 백틱으로 감싸야 함
  )

# 1) 우선 numeric 타입 컬럼만 찾음
numeric_cols <- names(data_selected)[sapply(data_selected, is.numeric)]

# 2) 여기서도 B, C, D 등 메타열(문자형)이 섞여있으면 제외
#    원래 계획대로라면 AOI 카운트 열만 남겨야 함
#    예: meta_cols <- c("ProbeDisplayName","TargetName","HUGOSymbol", ...)
meta_cols <- c("ProbeDisplayName", "TargetName", "HUGOSymbol") 
# 실제 이름과 맞춰 수정 가능

# 3) 최종적으로 우리가 sum을 구하고 싶은 AOI 열만 선택
aoi_cols <- setdiff(numeric_cols, meta_cols)

# 4) colSums
aoi_sum <- colSums(data_selected[aoi_cols], na.rm = TRUE)

## (예시) AOI outlier(너무 낮은 count) 필터링 기준 설정
## 실제론 boxplot/IQR/임계값/수동 선택 등 다양한 방식 가능
q1 <- quantile(aoi_sum, 0.25)
q3 <- quantile(aoi_sum, 0.75)
iqr_val <- q3 - q1
low_cutoff <- q1 - 1.5 * iqr_val  # 예: 1.5*IQR 미만이면 outlier로 간주
remove_aoi <- names(aoi_sum[aoi_sum < low_cutoff])

## 현재 데이터셋에서 특정 AOI(예: 4mm 68번)가 유일하게 이상치라고 가정
## 'remove_aoi'에 해당하면 필터링
data_filtered_aoi <- data_selected %>%
  select(-all_of(remove_aoi))

remove_aoi=names(aoi_sum[aoi_sum==min(aoi_sum)])
## 'remove_aoi'에 해당하면 필터링
data_filtered_aoi <- data_selected %>%
  dplyr::select(-all_of(remove_aoi))

aoi_cols=aoi_cols[aoi_sum!=min(aoi_sum)]

# -1.5IQR 미만인 AOI를 제거해준 후, negprobe만 선택
neg_data <- data_filtered_aoi %>%
  filter(grepl("NegProbe-WTX", ProbeDisplayName))

# 최솟값을 제거
neg_aoi <- neg_data[aoi_cols]
neg_geo_mean <- exp(rowMeans(log(neg_aoi), na.rm = TRUE))  # +1: log(0) 방지 --> 애초에 1이 더해져 있다.
neg_overall_geo_mean <- geoMean(neg_geo_mean, na.rm = TRUE)

neg_log_sd <- sd(log(neg_geo_mean), na.rm = TRUE)
LOQ <- exp(log(neg_overall_geo_mean) + 2 * neg_log_sd)

## NegProbe-WTX가 아닌 행만: (과거엔 filter(!grepl("NegProbe-WTX", B)) )
bio_data <- data_filtered_aoi %>%
  filter(!grepl("NegProbe-WTX", ProbeDisplayName))

bio_aoi <- bio_data[aoi_cols]
probe_geo_mean <- exp(rowMeans(log(bio_aoi), na.rm = TRUE))

## ratio_to_target: probe별 geomean / 해당 target의 geomean
ratio_to_target <- probe_geo_mean/geoMean(probe_geo_mean)

keep_idx_1 <- ratio_to_target >= 0.1


grubbs_percent_rosner <- apply(bio_aoi, 1, function(x) {
  # x: 한 probe의 모든 AOI 카운트
  # k = 최대 검출할 outlier 개수 (적당히 지정. 예: 전체 AOI 수의 10%나 20% 정도?)
  k_max <- floor(0.5 * length(x))  # 예) 최대 절반까지 outlier로 잡을 수 있다고 가정

  # rosnerTest로 한 번에 다중 outlier 검출
  # alpha는 0.05(기본), 필요시 조정
  # NOTE: x에 NA가 있으면 에러 -> na.omit(x) 등 미리 처리 필요
  out <- suppressWarnings(
    rosnerTest(na.omit(x), k = k_max)
  )

  # outlier로 판정된 관측치 개수
  n_out <- out$n.outliers

  # outlier 비율
  frac_out <- n_out / length(x)
  return(frac_out)
})

# grubbs test 안한다.
keep_idx_2 <- grubbs_percent_rosner < 10

bio_data_qc <- bio_data[keep_idx_1 & keep_idx_2, ]

length(keep_idx_2[keep_idx_2==TRUE])
length(keep_idx_1[keep_idx_1==TRUE])


## 2. Filter
## (주어진 frequency & threshold 조건)
## Frequency >= 10% segments above threshold
## Threshold = max(LOQ, user_defined=2) 등

threshold_used=LOQ
#threshold_used <- max(LOQ, 2)



bio_aoi_qc <- bio_data_qc[aoi_cols]

freq_above_geo <- apply(bio_aoi_qc, 1, function(x) {
  gm_x <- exp(mean(log(x), na.rm = TRUE))
  # geomean이 threshold_used보다 큰 경우 1, 그렇지 않으면 0
  as.numeric(gm_x >= threshold_used)
})
keep_idx_geo <- (freq_above_geo == 1)  # 또는 TRUE
bio_data_filtered <- bio_data_qc[keep_idx_geo, ]

## (예시) Area, Nuclei 정보는 다른 sheet("SegmentProperties")에서 불러온다고 가정

## manually remove the abnormal AOI
#SP=subset(SP,SegmentDisplayName!=remove_aoi) #remove_aoi가 없으면... 불필요

area_info <- SP$AOISurfaceArea
nuclei_info <- SP$AOINucleiCount
names(area_info) <- SP$SegmentDisplayName  # 실제 ID 컬럼 매핑 필요
names(nuclei_info) <- SP$SegmentDisplayName

## (예시) AOI이름과 SegmentID 매핑 필요. 스켈레톤 예시
## scale_to_area = count / geomean(area)
area_geo_mean <- exp(mean(log(area_info), na.rm = TRUE))
## scale_to_nuclei = count / geomean(nuclei)
nuclei_geo_mean <- exp(mean(log(nuclei_info), na.rm = TRUE))

scaled_data_area <- sweep(bio_data_filtered[aoi_cols], 2, area_info/area_geo_mean, "/")
scaled_data_nuclei <- sweep(bio_data_filtered[aoi_cols], 2, nuclei_info/nuclei_geo_mean, "/")
rownames(scaled_data_area)=bio_data_filtered$HUGOSymbol
rownames(scaled_data_nuclei)=bio_data_filtered$HUGOSymbol


## (예: NegProbe-WTX의 지오메트릭 평균, Signal-to-Background 등)
neg_probe_geo <- exp(colMeans(log(neg_aoi), na.rm=TRUE))
bg_corrected <- sweep(scaled_data_area, 2, neg_probe_geo, "/")  # 예: x1 배수

## (Q3, Geomean, 등 선택 가능. 여기선 Q3 예시)
norm_factors <- apply(bg_corrected, 2, quantile, 0.75)
data_norm <- sweep(bg_corrected, 2, norm_factors, "/")
rownames(data_norm)=bio_data_filtered$TargetName #HUGOSymbol이 좋은 선택인듯하다. CancerHallmark에서 TargetName을 뱉어냄. Metascape는 보긴 본다.
# 이 이유로 targetname을 배제한 게 좋지 않다. hugosymbol은 여러 개가 튀어나옴..

## metadata를 몇 개 더하고 t를 한 merged_df.
norm_factors_2=apply(bio_data_filtered[4:length(bio_data_filtered)], 2, quantile, 0.75)
data_norm_2=sweep(bio_data_filtered[4:length(bio_data_filtered)], 2, norm_factors_2, "/")
rownames(data_norm_2)=bio_data_filtered$HUGOSymbol

tag_data <- SP #%>% select(SegmentDisplayName, names(SP)[7:which(colnames(SP)=="QCFlags")-1]) # 등


expr_matrix <- do.call(cbind, data_norm)
expr_df <- as.data.frame(expr_matrix)
rownames(expr_df)=rownames(data_norm)
t_data=as.data.frame(t(expr_df))
t_data$AOI=colnames(data_norm)
merged_df <- merge(t_data, SP,
                   by.x = "AOI",
                   by.y = "SegmentDisplayName")  # 실제 key column 명 맞춰야



```

# make seurat and AddMetaData
deep > endo > histologic > mucosal
```{r}


names(data_norm)%in% rownames(sp)
data_norm=data_norm[,colnames(data_norm)%in% rownames(sp)]


data_seurat=CreateSeuratObject(data_norm)
data_seurat@assays$RNA$data=data_seurat@assays$RNA$counts

sp$barcode=rownames(sp)

rownames(sp)=sp$SegmentDisplayName
sp=sp[sp$SegmentDisplayName%in%rownames(data_seurat@meta.data),]

data_seurat=AddMetaData(data_seurat, sp)

md <- data_seurat@meta.data

# case_when() 적용
md <- md %>% mutate(
  heal = case_when(
    `Deep mucosal healing` == 1                      ~ 4,
    `Endo remission` == 1                             ~ 3,
    `histologic Endoscopic improvement` == 1          ~ 2,
    `mucosal healing` == 1                            ~ 1,
    `mucosal healing` == 0                            ~ 0,
    is.na(`mucosal healing`)                          ~ NA_real_,
    TRUE                                              ~ NA_real_
  )
)

# 다시 Seurat 객체에 덮어쓰기
data_seurat@meta.data$heal <- md$heal

data_seurat@meta.data$response=case_when(
  data_seurat@meta.data$heal%in%c(0,1)~"NR",
  data_seurat@meta.data$heal%in%c(2,3,4)~"R",
  TRUE ~ "NA"
)

```

# subsetting & DimPlot & PCAPlot
```{r}
data_seurat$drug=data_seurat$"약제종류"

data_seurat=ScaleData(data_seurat)
data_seurat=FindVariableFeatures(data_seurat)
data_seurat=RunPCA(data_seurat)
data_seurat=RunUMAP(data_seurat, dims = 1:30)

data_inf=subset(data_seurat, 약제종류=="Infliximab")
data_ust=subset(data_seurat, 약제종류=="Ustekinumab")
data_ved=subset(data_seurat, 약제종류=="Vedolizumab")

data_ck=subset(data_seurat, ck==TRUE)
# data_ck=FindNeighbors(data_ck)
# data_ck=FindClusters(data_ck, res=2)
data_str=subset(data_str, ck==FALSE)
# data_str=FindNeighbors(data_str)
# data_str=FindClusters(data_str, res=2)
data_ck_inf=subset(data_ck, 약제종류=="Infliximab")
data_ck_ust=subset(data_ck, 약제종류=="Ustekinumab")
data_ck_ved=subset(data_ck, 약제종류=="Vedolizumab")
data_str_inf=subset(data_str, 약제종류=="Infliximab")
data_str_ust=subset(data_str, 약제종류=="Ustekinumab")
data_str_ved=subset(data_str, 약제종류=="Vedolizumab")

data_ck_pre=subset(data_ck, treatment=="pre")
data_ck_post=subset(data_ck, treatment=="post")
data_str_pre=subset(data_str, treatment=="pre")
data_str_post=subset(data_str, treatment=="post")

data_ck_pre_inf=subset(data_ck_pre, 약제종류=="Infliximab")
data_ck_pre_ust=subset(data_ck_pre, 약제종류=="Ustekinumab")
data_ck_pre_ved=subset(data_ck_pre, 약제종류=="Vedolizumab")
data_ck_post_inf=subset(data_ck_post, 약제종류=="Infliximab")
data_ck_post_ust=subset(data_ck_post, 약제종류=="Ustekinumab")
data_ck_post_ved=subset(data_ck_post, 약제종류=="Vedolizumab")
data_str_pre_inf=subset(data_str_pre, 약제종류=="Infliximab")
data_str_pre_ust=subset(data_str_pre, 약제종류=="Ustekinumab")
data_str_pre_ved=subset(data_str_pre, 약제종류=="Vedolizumab")
data_str_post_inf=subset(data_str_post, 약제종류=="Infliximab")
data_str_post_ust=subset(data_str_post, 약제종류=="Ustekinumab")
data_st_postr_ved=subset(data_str_post, 약제종류=="Vedolizumab")



DimPlot(data_seurat, group.by="ck")
DimPlot(data_seurat, group.by="SlideName")
DimPlot(data_seurat, group.by="heal")
DimPlot(data_seurat, group.by="treatment")

DimPlot(data_ck, group.by="treatment")
DimPlot(data_ck, group.by="heal")

DimPlot(data_ck)
DimPlot(data_str)
```

## UMAP of centroids
```{r}
library(ggrepel)   # 레이블 겹침 방지용

# 1. UMAP embedding과 heal 메타데이터 추출
umap_df <- Embeddings(data_ck_pre, "umap") %>% 
  as.data.frame() %>% 
  # 열 이름 확인: 보통 "UMAP_1", "UMAP_2" 라고 나옵니다
  #rename(umap_1 = umap_1, umap_2 = umap_2) %>% 
  # 메타데이터에서 heal 값 붙이기
  mutate(heal = data_ck_pre@meta.data$heal)

# 2. 그룹별 centroid 계산 (각 축의 평균)
centroids <- umap_df %>% 
  group_by(heal) %>% 
  summarise(
    umap_1 = mean(umap_1),
    umap_2 = mean(umap_2)
  )

# 3. UMAP 점 찍고 centroid overlay
p <- ggplot(umap_df, aes(x = umap_1, y = umap_2, color = factor(heal))) +
  geom_point(alpha = 0.6, size = 0.5) +
  scale_color_brewer(palette = "Set1", name = "heal") +
  theme_classic() +
  labs(title = "UMAP with heal group centroids")

# centroid 추가: 검은 별표로, 그리고 레이블
p +
  geom_point(
    data = centroids,
    aes(x = umap_1, y = umap_2),
    shape = 8,       # 별표
    size = 4,
    color = "black"
  ) +
  geom_text_repel(
    data = centroids,
    aes(x = umap_1, y = umap_2, label = heal),
    size = 5,
    fontface = "bold",
    color = "black"
  )
```

# FindMarkers
```{r}
# t1 <- findMarkersLike(data_norm, sp, factor1 = "ck",
#                                  test_method = "t.test")
# t2 <- findMarkersLike(data_norm, sp, factor1 = "mucosal healing",
#                                  test_method = "t.test")
# t3=findMarkersLike(data_norm, sp, factor1 = "Endo remission",
#                                  test_method = "t.test")
# t4=findMarkersLike(data_norm, sp, factor1 = "histologic Endoscopic improvement",
#                                  test_method = "t.test")
# t5 <- findMarkersLike(data_norm, sp, factor1 = "Deep mucosal healing",
#                                  test_method = "t.test")
t=FindMarkers(data_seurat, ident.1 =4,ident.2=0, group.by="heal")%>%mutate(gene=rownames(.))
tt=FindMarkers(data_ck, ident.1 =4,ident.2=0, group.by="heal")%>%mutate(gene=rownames(.))
ttt=FindMarkers(data_str, ident.1 =4,ident.2=0, group.by="heal")%>%mutate(gene=rownames(.))

t2=FindMarkers(data_seurat, "1", group.by="mucosal healing")%>%mutate(gene=rownames(.))
t3=FindMarkers(data_seurat, "1", group.by="Endo remission")%>%mutate(gene=rownames(.))
t4=FindMarkers(data_seurat, "1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))
t5=FindMarkers(data_seurat, "1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))

t6=FindMarkers(data_ck, "1", group.by="mucosal healing")%>%mutate(gene=rownames(.))
t7=FindMarkers(data_ck, "1", group.by="Endo remission")%>%mutate(gene=rownames(.))
t8=FindMarkers(data_ck, "1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))
t9=FindMarkers(data_ck, "1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))

t10=FindMarkers(data_str, "1", group.by="mucosal healing")%>%mutate(gene=rownames(.))
t11=FindMarkers(data_str, "1", group.by="Endo remission")%>%mutate(gene=rownames(.))
t12=FindMarkers(data_str, "1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))
t13=FindMarkers(data_str, "1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))

t2_=t2%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t3_=t3%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t4_=t4%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t5_=t5%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t6_=t6%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t7_=t7%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t8_=t8%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t9_=t9%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t10_=t10%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t11_=t11%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t12_=t12%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t13_=t13%>%.[.$avg_log2FC>0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))

t2__=t2%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t3__=t3%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t4__=t4%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t5__=t5%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t6__=t6%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t7__=t7%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t8__=t8%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t9__=t9%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t10__=t10%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t11__=t11%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t12__=t12%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))
t13__=t13%>%.[.$avg_log2FC<0,]%>%.[.$p_val<0.05, ]%>%mutate(gene=rownames(.))


u1=upset_gene_lists(list(mucosal=t2_$gene,endo=t3_$gene,histo=t4_$gene,deep=t5_$gene))
u2=upset_gene_lists(list(mucosal=t2__$gene,endo=t3__$gene,histo=t4__$gene,deep=t5__$gene))
u3=upset_gene_lists(list(mucosal=t6_$gene,endo=t7_$gene,histo=t8_$gene,deep=t9_$gene))
u4=upset_gene_lists(list(mucosal=t6__$gene,endo=t7__$gene,histo=t8__$gene,deep=t9__$gene))
u5=upset_gene_lists(list(mucosal=t10_$gene,endo=t11_$gene,histo=t12_$gene,deep=t13_$gene))
u6=upset_gene_lists(list(mucosal=t10__$gene,endo=t11__$gene,histo=t12__$gene,deep=t13__$gene))


mibd_all1=union(t2_$gene,t3_$gene)%>%union(t4_$gene)%>%union(t5_$gene)
mibd_common1=intersect(t2_$gene,t3_$gene)%>%intersect(t4_$gene)%>%intersect(t5_$gene)
mibd_all2=union(t2__$gene,t3__$gene)%>%union(t4__$gene)%>%union(t5__$gene)
mibd_common2=intersect(t2__$gene,t3__$gene)%>%intersect(t4__$gene)%>%intersect(t5__$gene)

mibd_all3=union(t6_$gene,t7_$gene)%>%union(t8_$gene)%>%union(t9_$gene)
mibd_common3=intersect(t6_$gene,t7_$gene)%>%intersect(t8_$gene)%>%intersect(t9_$gene)
mibd_all4=union(t6__$gene,t7__$gene)%>%union(t8__$gene)%>%union(t9__$gene)
mibd_common4=intersect(t6__$gene,t7__$gene)%>%intersect(t8__$gene)%>%intersect(t9__$gene)

mibd_all5=union(t10_$gene,t11_$gene)%>%union(t12_$gene)%>%union(t13_$gene)
mibd_common5=intersect(t10_$gene,t11_$gene)%>%intersect(t12_$gene)%>%intersect(t13_$gene)
mibd_all6=union(t10__$gene,t11__$gene)%>%union(t12__$gene)%>%union(t13__$gene)
mibd_common6=intersect(t10__$gene,t11__$gene)%>%intersect(t12__$gene)%>%intersect(t13__$gene)

mibd_common1
mibd_common2
mibd_common3
mibd_common4
mibd_common5
mibd_common6
paste(mibd_all1,collapse=", ")
paste(mibd_all2,collapse=", ")
paste(mibd_all3,collapse=", ")
paste(mibd_all4,collapse=", ")
paste(mibd_all5,collapse=", ")
paste(mibd_all6,collapse=", ")

m_prepost=FindMarkers(data_seurat, ident.1 = "pre", group.by = "treatment")
m_prepost_ck=FindMarkers(data_ck, ident.1 = "pre", group.by = "treatment")
m_prepost_str=FindMarkers(data_str, ident.1 = "pre", group.by = "treatment")

# write.csv(t, "/data/kjc1/projects/#124. mIBD/csv/all_deep_vs_non_healing.csv")
# write.csv(tt, "/data/kjc1/projects/#124. mIBD/csv/ck_deep_vs_non_healing.csv")
# write.csv(ttt, "/data/kjc1/projects/#124. mIBD/csv/str_deep_vs_non_healing.csv")
# 
# write.csv(t2, "/data/kjc1/projects/#124. mIBD/csv/all_mucosal_healing.csv")
# write.csv(t3, "/data/kjc1/projects/#124. mIBD/csv/all_endo_healing.csv")
# write.csv(t4, "/data/kjc1/projects/#124. mIBD/csv/all_histology_healing.csv")
# write.csv(t5, "/data/kjc1/projects/#124. mIBD/csv/all_deep_healing.csv")
# write.csv(t6, "/data/kjc1/projects/#124. mIBD/csv/ck_mucosal_healing.csv")
# write.csv(t7, "/data/kjc1/projects/#124. mIBD/csv/ck_endo_healing.csv")
# write.csv(t8, "/data/kjc1/projects/#124. mIBD/csv/ck_histology_healing.csv")
# write.csv(t9, "/data/kjc1/projects/#124. mIBD/csv/ck_deep_healing.csv")
# write.csv(t10, "/data/kjc1/projects/#124. mIBD/csv/str_mucosal_healing.csv")
# write.csv(t11, "/data/kjc1/projects/#124. mIBD/csv/str_endo_healing.csv")
# write.csv(t12, "/data/kjc1/projects/#124. mIBD/csv/str_histology_healing.csv")
# write.csv(t13, "/data/kjc1/projects/#124. mIBD/csv/str_deep_healing.csv")
```

## subset by drugs
```{r}

```

### by healing

```{r}

m.in=FindMarkers(data_in, ident.1 ="4", group.by="heal")%>%mutate(gene=rownames(.), test.use="t")
m.us=FindMarkers(data_us, ident.1 ="3", group.by="heal")%>%mutate(gene=rownames(.), test.use="t")
m.ve=FindMarkers(data_ve, ident.1 ="4", group.by="heal")%>%mutate(gene=rownames(.), test.use="t")

m.ck.in=FindMarkers(ck_in, ident.1="4", group.by="heal")%>%mutate(gene=rownames(.), test.use="t")
m.ck.ve=FindMarkers(ck_ve, ident.1 ="4", group.by="heal")%>%mutate(gene=rownames(.), test.use="t")
m.str.in=FindMarkers(str_in, ident.1 ="4", group.by="heal")%>%mutate(gene=rownames(.), test.use="t")
m.str.ve=FindMarkers(str_ve, ident.1 ="4", group.by="heal")%>%mutate(gene=rownames(.), test.use="t")

m.in_=m.in%>%marker_trim(sign="+")%>%.[.$p_val<0.05,]
m.us_=m.us%>%marker_trim(sign="+")%>%.[.$p_val<0.05,]
m.ve_=m.ve%>%marker_trim(sign="+")%>%.[.$p_val<0.05,]

m.ck.in_=m.ck.in%>%marker_trim(sign="+")%>%.[.$p_val<0.05,]
m.ck.ve_=m.ck.ve%>%marker_trim(sign="+")%>%.[.$p_val<0.05,]

m.str.in_=m.str.in%>%marker_trim(sign="+")%>%.[.$p_val<0.05,]
m.str.ve_=m.str.ve%>%marker_trim(sign="+")%>%.[.$p_val<0.05,]


m.in__=m.in%>%marker_trim(sign="-")%>%.[.$p_val<0.05,]
m.us__=m.us%>%marker_trim(sign="-")%>%.[.$p_val<0.05,]
m.ve__=m.ve%>%marker_trim(sign="-")%>%.[.$p_val<0.05,]

m.ck.in__=m.ck.in%>%marker_trim(sign="-")%>%.[.$p_val<0.05,]
m.ck.ve__=m.ck.ve%>%marker_trim(sign="-")%>%.[.$p_val<0.05,]

m.str.in__=m.str.in%>%marker_trim(sign="-")%>%.[.$p_val<0.05,]
m.str.ve__=m.str.ve%>%marker_trim(sign="-")%>%.[.$p_val<0.05,]

u1=upset_gene_lists(list(Infli=m.in_$gene, Uste=m.us_$gene, Vedo=m.ve_$gene))
u2=upset_gene_lists(list(Infli=m.ck.in_$gene, Vedo=m.ck.ve_$gene))
u3=upset_gene_lists(list(Infli=m.str.in_$gene, Vedo=m.str.ve_$gene))
u4=upset_gene_lists(list(Infli=m.in__$gene, Uste=m.us__$gene, Vedo=m.ve__$gene))
u5=upset_gene_lists(list(Infli=m.ck.in__$gene, Vedo=m.ck.ve__$gene))
u6=upset_gene_lists(list(Infli=m.str.in__$gene, Vedo=m.str.ve__$gene))
```

### by pre vs post
```{r}
m.in.pre=FindMarkers(data_inf, ident.1 = "pre", group.by="treat")
m.us.pre=FindMarkers(data_ust, ident.1 = "pre", group.by="treat")
m.ve.pre=FindMarkers(data_ved, ident.1 = "pre", group.by="treat")
m.in.ck.pre=FindMarkers(data_ck_inf, ident.1 = "pre", group.by="treat")
m.us.ck.pre=FindMarkers(data_ck_ust, ident.1 = "pre", group.by="treat")
m.ve.ck.pre=FindMarkers(data_ck_ved, ident.1 = "pre", group.by="treat")
m.in.str.pre=FindMarkers(data_str_inf, ident.1 = "pre", group.by="treat")
m.us.str.pre=FindMarkers(data_str_ust, ident.1 = "pre", group.by="treat")
m.ve.str.pre=FindMarkers(data_str_ved, ident.1 = "pre", group.by="treat")

m.in.pl=m.in.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.mi=m.in.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC< -2,]
m.us.pl=m.us.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.us.mi=m.us.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC< -2,]
m.ve.pl=m.ve.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.mi=m.ve.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC< -2,]
m.in.ck.pl=m.in.ck.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.ck.mi=m.in.ck.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC< -2,]
m.us.ck.pl=m.us.ck.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.us.ck.mi=m.us.ck.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC< -2,]
m.ve.ck.pl=m.ve.ck.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.ck.mi=m.ve.ck.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC< -2,]
m.in.str.pl=m.in.str.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.str.mi=m.in.str.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC< -2,]
m.us.str.pl=m.us.str.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.us.str.mi=m.us.str.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC< -2,]
m.ve.str.pl=m.ve.str.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.str.mi=m.ve.str.pre%>%marker_filter()%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC< -2,]

m.pre.drugs=intersect(intersect(m.in.pl$gene, m.us.pl$gene),m.ve.pl$gene)
m.post.drugs=intersect(intersect(m.in.mi$gene, m.us.mi$gene),m.ve.mi$gene)
m.ck.pre.drugs=intersect(intersect(m.in.ck.pl$gene, m.us.ck.pl$gene),m.ve.ck.pl$gene)
m.ck.post.drugs=intersect(intersect(m.in.ck.mi$gene, m.us.ck.mi$gene),m.ve.ck.mi$gene)
m.str.pre.drugs=intersect(intersect(m.in.str.pl$gene, m.us.str.pl$gene),m.ve.str.pl$gene)
m.str.post.drugs=intersect(intersect(m.in.str.mi$gene, m.us.str.mi$gene),m.ve.str.mi$gene)

marker_print(m.in.pl)
marker_print(m.in.mi)
marker_print(m.us.pl)
marker_print(m.us.mi)
marker_print(m.ve.pl)
marker_print(m.ve.mi)
marker_print(m.in.ck.pl)
marker_print(m.in.ck.mi)
marker_print(m.us.ck.pl)
marker_print(m.us.ck.mi)
marker_print(m.ve.ck.pl)
marker_print(m.ve.ck.mi)
marker_print(m.in.str.pl)
marker_print(m.in.str.mi)
marker_print(m.us.str.pl)
marker_print(m.us.str.mi)
marker_print(m.ve.str.pl)
marker_print(m.ve.str.mi)

plot_g1=ggvenn(list(pre_ck_inf=m.in.ck.pl$gene,
                   pre_ck_ved=m.ve.ck.pl$gene,
                   pre_ck_ust=m.us.ck.pl$gene))
plot_g2=ggvenn(list(post_ck_inf=m.in.ck.mi$gene,
                   post_ck_ved=m.ve.ck.mi$gene,
                   post_ck_ust=m.us.ck.mi$gene))
plot_g3=ggvenn(list(pre_str_inf=m.in.str.pl$gene,
                   pre_str_ved=m.ve.str.pl$gene,
                   pre_str_ust=m.us.str.pl$gene))
plot_g4=ggvenn(list(post_str_inf=m.in.str.mi$gene,
                   post_str_ved=m.ve.str.mi$gene,
                   post_str_ust=m.us.str.mi$gene))
print(intersect(m.in.ck.pl$gene, m.ve.ck.pl$gene))
print(intersect(m.us.ck.pl$gene, m.ve.ck.pl$gene))
print(intersect(m.in.ck.pl$gene, m.us.ck.pl$gene))
print(intersect(m.in.ck.mi$gene, m.ve.ck.mi$gene))
print(intersect(m.us.ck.mi$gene, m.ve.ck.mi$gene))
print(intersect(m.in.ck.mi$gene, m.us.ck.mi$gene))
print(intersect(m.in.str.pl$gene, m.ve.str.pl$gene))
print(intersect(m.us.str.pl$gene, m.ve.str.pl$gene))
print(intersect(m.in.str.pl$gene, m.us.str.pl$gene))
print(paste(intersect(m.in.str.mi$gene, m.ve.str.mi$gene),collapse = ", "))
print(paste(intersect(m.us.str.mi$gene, m.ve.str.mi$gene),collapse = ", "))
print(paste(intersect(m.in.str.mi$gene, m.us.str.mi$gene),collapse = ", "))


print(intersect(intersect(m.in.ck.mi$gene, m.us.ck.mi$gene),m.ve.ck.mi$gene))
print(intersect(intersect(m.in.str.mi$gene, m.us.str.mi$gene),m.ve.str.mi$gene))
```

### by each healing

#### infliximab
```{r}
m.in.ck.1=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.ck.2=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.ck.3=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.ck.4=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.str.1=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.str.2=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.str.3=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.str.4=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]


m.in.ck.1.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.ck.2.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.ck.3.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.ck.4.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.str.1.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.str.2.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.str.3.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.in.str.4.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]




# 
# m.in.ck.1.post=FindMarkers(subset(data_inf, treatment=="post"&ck==TRUE), ident.1 ="1", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.in.ck.2.post=FindMarkers(subset(data_inf, treatment=="post"&ck==TRUE), ident.1 ="1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.in.ck.3.post=FindMarkers(subset(data_inf, treatment=="post"&ck==TRUE), ident.1 ="1", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.in.ck.4.post=FindMarkers(subset(data_inf, treatment=="post"&ck==TRUE), ident.1 ="1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.in.str.1.post=FindMarkers(subset(data_inf, treatment=="post"&ck==FALSE), ident.1 ="1", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.in.str.2.post=FindMarkers(subset(data_inf, treatment=="post"&ck==FALSE), ident.1 ="1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.in.str.3.post=FindMarkers(subset(data_inf, treatment=="post"&ck==FALSE), ident.1 ="1", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.in.str.4.post=FindMarkers(subset(data_inf, treatment=="post"&ck==FALSE), ident.1 ="1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# 
# data_inf
# data_ust
# data_ved
# 
# m.in.pre=FindMarkers(data_inf, ident.1 = "pre", group.by="treat")
# m.us.pre=FindMarkers(data_ust, ident.1 = "pre", group.by="treat")
# m.ve.pre=FindMarkers(data_ved, ident.1 = "pre", group.by="treat")
# data_inf$`mucosal healing`
# data_inf$`Deep mucosal healing`
# data_inf$`histologic Endoscopic improvement`
# data_inf$`Endo remission`

plot_g1=ggvenn(list(pre_inf_ck_1=m.in.ck.1$gene,
                   pre_inf_ck_2=m.in.ck.2$gene,
                   pre_inf_ck_3=m.in.ck.3$gene,
                   pre_inf_ck_4=m.in.ck.4$gene))
plot_g2=ggvenn(list(pre_inf_str_1=m.in.str.1$gene,
                   pre_inf_str_2=m.in.str.2$gene,
                   pre_inf_str_3=m.in.str.3$gene,
                   pre_inf_str_4=m.in.str.4$gene))

plot_g3=ggvenn(list(bad_inf_ck_1=m.in.ck.1.bad$gene,
                   bad_inf_ck_2=m.in.ck.2.bad$gene,
                   bad_inf_ck_3=m.in.ck.3.bad$gene,
                   bad_inf_ck_4=m.in.ck.4.bad$gene))
plot_g4=ggvenn(list(pre_inf_str_1=m.in.str.1.bad$gene,
                   bad_inf_str_2=m.in.str.2.bad$gene,
                   bad_inf_str_3=m.in.str.3.bad$gene,
                   bad_inf_str_4=m.in.str.4.bad$gene))

print(intersect(m.in.ck.1$gene, m.in.ck.2$gene))
print(intersect(m.in.ck.1$gene, m.in.ck.3$gene))
print(intersect(m.in.ck.1$gene, m.in.ck.4$gene))
print(intersect(m.in.ck.2$gene, m.in.ck.3$gene))
print(intersect(m.in.ck.2$gene, m.in.ck.4$gene))
print(intersect(m.in.ck.3$gene, m.in.ck.4$gene))
print(intersect(intersect(m.in.ck.1$gene, m.in.ck.2$gene),m.in.ck.3$gene))
print(intersect(intersect(m.in.ck.1$gene, m.in.ck.2$gene),m.in.ck.4$gene))
print(intersect(intersect(m.in.ck.1$gene, m.in.ck.3$gene),m.in.ck.4$gene))
print(intersect(intersect(m.in.ck.2$gene, m.in.ck.3$gene),m.in.ck.4$gene))
print(intersect(intersect(intersect(m.in.ck.1$gene, m.in.ck.2$gene),m.in.ck.3$gene),m.in.ck.4$gene))

print(intersect(m.in.str.1$gene, m.in.str.2$gene))
print(intersect(m.in.str.1$gene, m.in.str.3$gene))
print(intersect(m.in.str.1$gene, m.in.str.4$gene))
print(intersect(m.in.str.2$gene, m.in.str.3$gene))
print(intersect(m.in.str.2$gene, m.in.str.4$gene))
print(intersect(m.in.str.3$gene, m.in.str.4$gene))

print(intersect(m.in.ck.1.bad$gene, m.in.ck.2.bad$gene))
print(intersect(m.in.ck.1.bad$gene, m.in.ck.3.bad$gene))
print(intersect(m.in.ck.1.bad$gene, m.in.ck.4.bad$gene))
print(intersect(m.in.ck.2.bad$gene, m.in.ck.3.bad$gene))
print(intersect(m.in.ck.2.bad$gene, m.in.ck.4.bad$gene))
print(intersect(m.in.ck.3.bad$gene, m.in.ck.4.bad$gene))

print(intersect(m.in.str.1.bad$gene, m.in.str.2.bad$gene))
print(intersect(m.in.str.1.bad$gene, m.in.str.3.bad$gene))
print(intersect(m.in.str.1.bad$gene, m.in.str.4.bad$gene))
print(intersect(m.in.str.2.bad$gene, m.in.str.3.bad$gene))
print(intersect(m.in.str.2.bad$gene, m.in.str.4.bad$gene))
print(intersect(m.in.str.3.bad$gene, m.in.str.4.bad$gene))

```

#### vedolizumab
```{r}
# m.ve.ck.1=FindMarkers(subset(data_ved, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.ve.ck.2=FindMarkers(subset(data_ved, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.ck.3=FindMarkers(subset(data_ved, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.ck.4=FindMarkers(subset(data_ved, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.ve.str.1=FindMarkers(subset(data_ved, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.ve.str.2=FindMarkers(subset(data_ved, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.str.3=FindMarkers(subset(data_ved, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.str.4=FindMarkers(subset(data_ved, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]


# m.ve.ck.1.bad=FindMarkers(subset(data_ved, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.ve.ck.2.bad=FindMarkers(subset(data_ved, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.ck.3.bad=FindMarkers(subset(data_ved, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.ck.4.bad=FindMarkers(subset(data_ved, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.ve.str.1.bad=FindMarkers(subset(data_ved, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
# m.ve.str.2.bad=FindMarkers(subset(data_ved, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.str.3.bad=FindMarkers(subset(data_ved, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="Endo remission")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]
m.ve.str.4.bad=FindMarkers(subset(data_ved, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))%>%.[.$p_val<0.05,]%>%.[.$avg_log2FC>2,]

# print(intersect(m.ve.ck.1$gene, m.ve.ck.2$gene))
# print(intersect(m.ve.ck.1$gene, m.ve.ck.3$gene))
# print(intersect(m.ve.ck.1$gene, m.ve.ck.4$gene))
# print(intersect(m.ve.ck.2$gene, m.ve.ck.3$gene))
# print(intersect(m.ve.ck.2$gene, m.ve.ck.4$gene))
print(intersect(m.ve.ck.3$gene, m.ve.ck.4$gene))

# print(intersect(m.ve.str.1$gene, m.ve.str.2$gene))
# print(intersect(m.ve.str.1$gene, m.ve.str.3$gene))
# print(intersect(m.ve.str.1$gene, m.ve.str.4$gene))
# print(intersect(m.ve.str.2$gene, m.ve.str.3$gene))
# print(intersect(m.ve.str.2$gene, m.ve.str.4$gene))
print(intersect(m.ve.str.3$gene, m.ve.str.4$gene))

# print(intersect(m.ve.ck.1.bad$gene, m.ve.ck.2.bad$gene))
# print(intersect(m.ve.ck.1.bad$gene, m.ve.ck.3.bad$gene))
# print(intersect(m.ve.ck.1.bad$gene, m.ve.ck.4.bad$gene))
# print(intersect(m.ve.ck.2.bad$gene, m.ve.ck.3.bad$gene))
# print(intersect(m.ve.ck.2.bad$gene, m.ve.ck.4.bad$gene))
print(intersect(m.ve.ck.3.bad$gene, m.ve.ck.4.bad$gene))

# print(intersect(m.ve.str.1.bad$gene, m.ve.str.2.bad$gene))
# print(intersect(m.ve.str.1.bad$gene, m.ve.str.3.bad$gene))
# print(intersect(m.ve.str.1.bad$gene, m.ve.str.4.bad$gene))
# print(intersect(m.ve.str.2.bad$gene, m.ve.str.3.bad$gene))
# print(intersect(m.ve.str.2.bad$gene, m.ve.str.4.bad$gene))
print(intersect(m.ve.str.3.bad$gene, m.ve.str.4.bad$gene))

```

#### unions
```{r}
in_ck_good=union(union(union(m.in.ck.1$gene, m.in.ck.2$gene),m.in.ck.3$gene),m.in.ck.4$gene)
in_str_good=union(union(union(m.in.str.1$gene, m.in.str.2$gene),m.in.str.3$gene),m.in.str.4$gene)
ve_ck_good=union(m.ve.ck.3$gene,m.ve.ck.4$gene)
ve_str_good=union(m.ve.str.3$gene,m.ve.str.4$gene)

in_ck_bad=union(union(union(m.in.ck.1.bad$gene, m.in.ck.2.bad$gene),m.in.ck.3.bad$gene),m.in.ck.4.bad$gene)
in_str_bad=union(union(union(m.in.str.1.bad$gene, m.in.str.2.bad$gene),m.in.str.3.bad$gene),m.in.str.4.bad$gene)
ve_ck_bad=union(m.ve.ck.3.bad$gene,m.ve.ck.4.bad$gene)
ve_str_bad=union(m.ve.str.3.bad$gene,m.ve.str.4.bad$gene)

print(union(union(union(m.in.ck.1$gene, m.in.ck.2$gene),m.in.ck.3$gene),m.in.ck.4$gene))
print(union(union(union(m.in.str.1$gene, m.in.str.2$gene),m.in.str.3$gene),m.in.str.4$gene))
print(union(m.ve.ck.3$gene,m.ve.ck.4$gene))
print(union(m.ve.str.3$gene,m.ve.str.4$gene))

print(union(union(union(m.in.ck.1.bad$gene, m.in.ck.2.bad$gene),m.in.ck.3.bad$gene),m.in.ck.4.bad$gene))
print(union(union(union(m.in.str.1.bad$gene, m.in.str.2.bad$gene),m.in.str.3.bad$gene),m.in.str.4.bad$gene))
print(union(m.ve.ck.3.bad$gene,m.ve.ck.4.bad$gene))
print(union(m.ve.str.3.bad$gene,m.ve.str.4.bad$gene))

plot_u1=ggvenn(list(in_ck_good=in_ck_good,
                    in_str_good=in_str_good,
                    ve_ck_good=ve_ck_good,
                    ve_str_good=ve_str_good))
plot_u2=ggvenn(list(in_ck_bad=in_ck_bad,
                    in_str_bad=in_str_bad,
                    ve_ck_bad=ve_ck_bad,
                    ve_str_bad=ve_str_bad))

print(intersect(in_ck_good, in_str_good))
print(intersect(ve_ck_good, ve_str_good))
print(intersect(in_ck_good, ve_ck_good))
print(intersect(in_str_good, ve_str_good))

print(intersect(in_ck_bad, in_str_bad))
print(intersect(ve_ck_bad, ve_str_bad))
print(intersect(in_ck_bad, ve_ck_bad))
print(intersect(in_str_bad, ve_str_bad))
```

#### signatures
```{r}
m.in.ck.1=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="mucosal healing")%>%mutate(gene=rownames(.))
m.in.ck.2=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))
m.in.ck.3=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="Endo remission")%>%mutate(gene=rownames(.))
m.in.ck.4=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))
m.in.str.1=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="mucosal healing")%>%mutate(gene=rownames(.))
m.in.str.2=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))
m.in.str.3=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="Endo remission")%>%mutate(gene=rownames(.))
m.in.str.4=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="1", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))


m.in.ck.1.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="mucosal healing")%>%mutate(gene=rownames(.))
m.in.ck.2.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))
m.in.ck.3.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="Endo remission")%>%mutate(gene=rownames(.))
m.in.ck.4.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==TRUE), ident.1 ="0", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))
m.in.str.1.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="mucosal healing")%>%mutate(gene=rownames(.))
m.in.str.2.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="histologic Endoscopic improvement")%>%mutate(gene=rownames(.))
m.in.str.3.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="Endo remission")%>%mutate(gene=rownames(.))
m.in.str.4.bad=FindMarkers(subset(data_inf, treatment=="pre"&ck==FALSE), ident.1 ="0", group.by="Deep mucosal healing")%>%mutate(gene=rownames(.))

m.in.ck.1[m.in.ck.1$gene%in%downstream_manual,]
m.in.ck.2[m.in.ck.2$gene%in%downstream_manual,]
m.in.ck.3[m.in.ck.3$gene%in%downstream_manual,]
m.in.ck.4[m.in.ck.4$gene%in%downstream_manual,]
m.in.ck.1.bad[m.in.ck.1.bad$gene%in%downstream_manual,]
m.in.ck.2.bad[m.in.ck.2.bad$gene%in%downstream_manual,]
m.in.ck.3.bad[m.in.ck.3.bad$gene%in%downstream_manual,]
m.in.ck.4.bad[m.in.ck.4.bad$gene%in%downstream_manual,]
m.in.str.1[m.in.str.1$gene%in%downstream_manual,]
m.in.str.2[m.in.str.2$gene%in%downstream_manual,]
m.in.str.3[m.in.str.3$gene%in%downstream_manual,]
m.in.str.4[m.in.str.4$gene%in%downstream_manual,]
m.in.str.1.bad[m.in.str.1.bad$gene%in%downstream_manual,]
m.in.str.2.bad[m.in.str.2.bad$gene%in%downstream_manual,]
m.in.str.3.bad[m.in.str.3.bad$gene%in%downstream_manual,]
m.in.str.4.bad[m.in.str.4.bad$gene%in%downstream_manual,]

m.ve.ck.3.bad[m.ve.ck.3.bad$gene%in%downstream_manual,]
m.ve.ck.4.bad[m.ve.ck.4.bad$gene%in%downstream_manual,]
m.ve.str.3.bad[m.ve.str.3.bad$gene%in%downstream_manual,]
m.ve.str.4.bad[m.ve.str.4.bad$gene%in%downstream_manual,]

m.in.ck.1$avg2=m.in.ck.2[m.in.ck.2$gene%in%m.in.ck.1$gene,]$avg_log2FC
```

# TNF signature
## gene candidates
### DBs
```{r}
library(msigdbr)
## MSigDB (curated → 안정적·재현성 좋음)
hallmark  <- msigdbr(species = "Homo sapiens", category = "H") %>%
  filter(gs_name == "HALLMARK_TNFA_SIGNALING_VIA_NFKB") %>% 
  pull(gene_symbol) %>% unique()

reactome <- msigdbr(species = "Homo sapiens", category = "C2", subcategory = "CP:REACTOME") %>%
  filter(grepl("TNF|NFkB", gs_name, ignore.case = TRUE)) %>% 
  pull(gene_symbol) %>% unique()

kegg <- msigdbr(species = "Homo sapiens", category = "C2", subcategory = "CP:KEGG") %>% 
  filter(gs_name == "KEGG_TNF_SIGNALING_PATHWAY") %>% 
  pull(gene_symbol) %>% unique()

candidate_genes <- union(hallmark, union(reactome, kegg))
length(candidate_genes)


```



### hand curation
```{r}
# upstream (regulators / receptors / key transducers)
upstream_manual <- c("TNF", "LTA", "LTB",              # ligands
                     "TNFRSF1A", "TNFRSF1B",          # receptors
                     "TRADD", "RIPK1", "TRAF2", "TRAF5",
                     "CHUK", "IKBKB", "IKBKG", "MAP3K7",
                     "NFKB1", "NFKB2", "RELA", "RELB")

# downstream (classical early-response TNF targets)
downstream_manual <- c("IL6", "IL8", "CXCL1", "CXCL2", "CXCL3", "CXCL10",
                       "CCL2", "CCL5", "ICAM1", "VCAM1",
                       "PTGS2", "MMP1", "MMP9",
                       "SERPINE1", "CSF2", "LIF", "NFKBIA")
```
### duplicates removal
```{r}
gene_pool <- union(candidate_genes, union(upstream_manual, downstream_manual))
gene_pool <- gene_pool[gene_pool %in% rownames(data_seurat)]  # 발현 확인
length(gene_pool)
```

## gene filtering
```{r}
library(caret)        # 머신러닝 도구
library(pROC)         # AUROC 계산

# 3-a. Infliximab 치료군만 subset & heal 기반 반응(Responder/NR) 레이블 정의
seu_inf <- subset(data_seurat, subset = 약제종류 == "Infliximab")
seu_inf$resp <- ifelse(seu_inf$heal <= 1, "NR", "R")

# 3-b. 셀 이름 기준으로 훈련/검증 셀 분리
set.seed(2025)
cells_inf    <- colnames(seu_inf)
train_cells  <- sample(cells_inf, size = floor(0.7 * length(cells_inf)))
valid_cells  <- setdiff(cells_inf, train_cells)

# 3-c. metadata에서 이름으로 레이블 추출 (unnamed vector 문제 해결)
train_lab <- seu_inf@meta.data[train_cells, "resp"]
valid_lab <- seu_inf@meta.data[valid_cells, "resp"]

# 3-d. expr 매트릭스 불러오기 (subset된 객체에서)
expr_mat <- GetAssayData(seu_inf, slot = "data")[gene_pool, ]

# 3-b. 발현률·변동성 필터
# expr_mat <- GetAssayData(data_seurat, slot = "data")[gene_pool, ]
expr_pct <- Matrix::rowMeans(expr_mat > 0)
expr_var <- MatrixGenerics::rowVars(expr_mat)

keep <- gene_pool[expr_pct > 0.05 & expr_var > median(expr_var)]
length(keep)

# 3-c. 훈련셋 AUROC 기반 top-N 선택
library(purrr)
auc_vec <- map_dbl(
  keep,
  ~ {
    roc_obj <- roc(
      train_lab,                 # a named vector of length length(train_cells)
      expr_mat[.x, train_cells], # use train_cells instead of train_idx
      levels    = c("NR", "R"),
      direction = "<"
    )
    as.numeric(roc_obj$auc)
  }
)

gene_rank <- tibble(gene = keep, auc = auc_vec) %>% arrange(desc(auc))
head(gene_rank, 20)

top_upstream   <- head(filter(gene_rank, gene %in% upstream_manual),  20)$gene
top_downstream <- head(filter(gene_rank, gene %in% downstream_manual), 20)$gene
top10=gene_rank[1:10,]$gene
top10_=gene_rank[length(gene_rank$gene)-9:length(gene_rank$gene),]$gene
top30=gene_rank[1:30,]$gene
top30_=gene_rank[length(gene_rank$gene)-29:length(gene_rank$gene),]$gene
top50=gene_rank[1:50,]$gene
top50_=gene_rank[length(gene_rank$gene)-49:length(gene_rank$gene),]$gene

# 3-d. 최종 모듈 (리스트 형식, AddModuleScore용)
module_list <- list(
  TNF_Upstream   = top_upstream,
  TNF_Downstream = top_downstream
)

# 3-e. AddModuleScore
data_seurat <- AddModuleScore(
  object = data_seurat,
  features = module_list,
  name = c("TNF_Upstream_Score", "TNF_Downstream_Score")
)


module_total=list(
  TNF_Upstream   = top_upstream,
  TNF_Downstream = top_downstream,
  Top10=top10,
  Bottom10=top10_,
  gene_total=gene_pool,
  gene_variable=keep,
  Top50=top50,
  Bottom50=top50_,
  Top30=top30,
  Bottom30=top30_
  )
```
## plotting for TNF signature
```{r}
VlnPlot(data_seurat, c("TNF_Upstream_Score1", "TNF_Downstream_Score2"), split.by="heal", group.by = "ck")

myhm_genesets2(data_seurat, group="heal", assay = "RNA", gene_sets = module_total)

myhm_genesets2(data_seurat, group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(data_ck, group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(data_str, group="heal", assay = "RNA", gene_sets = module_list)

myhm_genesets2(subset(data_seurat,treatment=="pre"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_seurat,treatment=="post"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_ck,treatment=="pre"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_ck,treatment=="post"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_str,treatment=="pre"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_str,treatment=="post"), group="heal", assay = "RNA", gene_sets = module_list)

myhm_genesets2(subset(data_seurat,약제종류=="Infliximab"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_seurat,약제종류!="Infliximab"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_ck,약제종류=="Infliximab"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_ck,약제종류!="Infliximab"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_str,약제종류=="Infliximab"), group="heal", assay = "RNA", gene_sets = module_list)
myhm_genesets2(subset(data_str,약제종류!="Infliximab"), group="heal", assay = "RNA", gene_sets = module_list)

# VlnPlot도 다 나눠서 해봐야....
```

## Ustekinumab & Vedolizumab
```{r}
## ── 1. MSigDB에서 경로별 유전자 세트 끌어오기 ─────────
# 1-a. 모든 H(=Hallmark), C2:KEGG, C2:REACTOME 가져오기
msig_H <- msigdbr(species = "Homo sapiens", category = "H")
msig_R <- msigdbr(species = "Homo sapiens",
                  category = "C2", subcategory = "CP:REACTOME")
msig_K <- msigdbr(species = "Homo sapiens",
                  category = "C2", subcategory = "CP:KEGG")

# 1-b. 약제 기전 키워드로 필터링
ustek_kw <- c("IL12", "IL23", "INTERLEUKIN_12", "INTERLEUKIN_23", "STAT4")
vedo_kw  <- c("INTEGRIN", "LEUKOCYTE_TRA", "ADHESION")

grab_genes <- function(tbl, keywords) {
  tbl %>%
    filter(stringr::str_detect(gs_name, str_c(keywords, collapse = "|"), ignore_case = TRUE)) %>%
    pull(gene_symbol) %>% unique()
}
grab_genes <- function(tbl, keywords) {
  # build a single “or” pattern
  pat <- str_c(keywords, collapse = "|")
  
  tbl %>%
    filter(str_detect(gs_name, regex(pat, ignore_case = TRUE))) %>%
    pull(gene_symbol) %>%
    unique()
}

ustek_path_genes <- unique(c(
  grab_genes(msig_H, ustek_kw),
  grab_genes(msig_R, ustek_kw),
  grab_genes(msig_K, ustek_kw)
))

vedo_path_genes <- unique(c(
  grab_genes(msig_H, vedo_kw),
  grab_genes(msig_R, vedo_kw),
  grab_genes(msig_K, vedo_kw)
))

## ── 2. 수동 리스트와 병합 ─────────────────────────────
# 수동 리스트(앞서 작성)
ustek_up   <- c("IL12A","IL12B","IL23A","IL12RB1","IL12RB2","IL23R","JAK2","STAT4")
ustek_down <- c("IFNG","CXCL9","CXCL10","SOCS3","IRF1","TNFSF10","CCL3","CCL4")

vedo_up    <- c("ITGA4","ITGB7","MADCAM1")
vedo_down  <- c("PTK2","PXN","VAV1","RAC1","CDC42","TALIN1","TLN1","FERMT3")

# MSigDB → Upstream/Downstream에 편리하게 나누려면,
# 간단히 '리간드/수용체·키나아제' vs 'Effector/타겟' 식으로 분할
ustek_up_all   <- unique(c(ustek_up,
                           intersect(ustek_path_genes,
                                     c("IL12A","IL12B","IL23A","IL23R","IL12RB1","IL12RB2",
                                       "JAK2","TYK2","STAT4","STAT3","STAT1"))))
ustek_down_all <- unique(c(ustek_down, setdiff(ustek_path_genes, ustek_up_all)))

vedo_up_all    <- unique(c(vedo_up,
                           intersect(vedo_path_genes,
                                     c("ITGA4","ITGB7","ITGB1","MADCAM1","VCAM1"))))
vedo_down_all  <- unique(c(vedo_down, setdiff(vedo_path_genes, vedo_up_all)))

## ── 3. 약제별 모듈 리스트 완성 ────────────────────────
modules <- list(
  Ustekinumab = list(Upstream = ustek_up_all, Downstream = ustek_down_all),
  Vedolizumab = list(Upstream = vedo_up_all,  Downstream = vedo_down_all)
)

modules_usve=list(usup=ustek_up_all,usdown=ustek_down_all, vedoup=vedo_up_all, vedodown=vedo_down_all)

data_seurat=AddModuleScore(data_seurat,features=modules_usve,name=names(modules_usve))

VlnPlot(data_seurat, features=c("usup1","usdown2","vedoup3","vedodown4"), split.by = "heal", group.by="약제종류")
VlnPlot(data_seurat, features=c("usup1","usdown2","vedoup3","vedodown4"), split.by = "response", group.by="약제종류")

myhm_genes2(data_seurat, group="heal", assay="RNA", genes=top_upstream)
myhm_genes2(data_seurat, group="heal", assay="RNA", genes=top_downstream)
myhm_genes2(data_seurat, group="heal", assay="RNA", genes=ustek_up_all)
myhm_genes2(data_seurat, group="heal", assay="RNA", genes=vedo_up_all)

myhm_genes2(data_seurat, group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(data_seurat, group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(data_seurat, group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(data_seurat, group="treatment", assay="RNA", genes=vedo_up_all)

myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="heal", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="heal", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="heal", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="heal", assay="RNA", genes=vedo_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="heal", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="heal", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="heal", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="heal", assay="RNA", genes=vedo_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="heal", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="heal", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="heal", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="heal", assay="RNA", genes=vedo_up_all)

myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="treatment", assay="RNA", genes=vedo_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="treatment", assay="RNA", genes=vedo_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="treatment", assay="RNA", genes=vedo_up_all)

myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="treatment", assay="RNA", genes=gene_rank[1:20,]$gene)

myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"&ck==TRUE), group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"&ck==TRUE), group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"&ck==TRUE), group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"&ck==TRUE), group="treatment", assay="RNA", genes=vedo_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"&ck==TRUE), group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"&ck==TRUE), group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"&ck==TRUE), group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"&ck==TRUE), group="treatment", assay="RNA", genes=vedo_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"&ck==TRUE), group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"&ck==TRUE), group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"&ck==TRUE), group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"&ck==TRUE), group="treatment", assay="RNA", genes=vedo_up_all)

myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Infliximab"), group="treatment", assay="RNA", genes=vedo_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Ustekinumab"), group="treatment", assay="RNA", genes=vedo_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="treatment", assay="RNA", genes=top_upstream)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="treatment", assay="RNA", genes=top_downstream)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="treatment", assay="RNA", genes=ustek_up_all)
myhm_genes2(subset(data_seurat, 약제종류=="Vedolizumab"), group="treatment", assay="RNA", genes=vedo_up_all)

```

# NN

```{r}
NN_analysis_tc4=run_nichenet_analysis_legacy(data_seurat,
                                 species = c("human"),
                                 sender_celltypes=FALSE,
                                 receiver_celltype=TRUE,
                                 assay_name = "SCT",
                                 cluster_col="ck",
                                 receiver_DE_ident1="2",
                                 receiver_DE_ident2 = NULL,
                                 receiver_DE_group_by="group3",
                                 min_pct_expressed = 0.10,
                                 p_val_adj_cutoff = 0.05,
                                 logfc_cutoff = 0.25,
                                 top_n_ligands = 20,
                                 top_n_targets_per_ligand = 200,
                                 ligand_target_cutoff = 0.33,
                                 nichenet_data_dir ="/data/kjc1/projects/NicheNet",
                                 nichenet_data_name= "NicheNetData",
                                 output_dir ="/data/kjc1/mylit/plots/NicheNet/",
                                 run_circos = TRUE,
                                 run_signaling_path_inference = TRUE,
                                 verbose = TRUE)
```





# legacy

#plotting
```{r}

tn1 <- findMarkersLike(data_norm, sp, factor1 = "BAD",
                                 test_method = "t.test")
tn2 <- findMarkersLike(data_norm, sp, factor1 = "RS",
                                 test_method = "t.test")
# t22=findMarkersLike(data_norm, sp, factor1 = "SMA+",factor2="SMA-",
#                                  test_method = "t.test")
t6=findMarkersLike(data_norm,sp,factor1="BAD_RE")
t7=findMarkersLike(data_norm,sp,factor1="RS_RE")
sp$RS_RE_=c(rep(T,15),rep(F,8),rep(T,24),rep(F,8))
t8=findMarkersLike(data_norm,sp,factor1="RS_RE_")

tn1_sorted=tn1[order(tn1$p_val_adj),]
tn2_sorted=tn2[order(tn2$p_val_adj),]
t4_sorted=t4[order(t4$p_val),]
t6_sorted=t6[order(t6$p_val_adj),]
t7_sorted=t7[order(t7$p_val),]

rownames(tn1_sorted)=1:length(rownames(tn1_sorted))
rownames(tn2_sorted)=1:length(rownames(tn2_sorted))
rownames(t4_sorted)=1:length(rownames(t4_sorted))

paste(tn1_sorted$gene[1:100],collapse =", " )
paste(tn2_sorted$gene[1:100],collapse =", " )
paste(t4_sorted$gene[1:100],collapse=", ")
```


```{r}
sp$RS_RERE=sp$RS
sp$RS_RERE[14]=T
sp$RS_RERE[15]=T
sp$RS_RERE[22]=F
sp$RS_RERE[23]=F
t8=findMarkersLike(data_norm,sp,factor1="RS_RERE")
t8_sorted=t8[order(t8$p_val_adj),]
rownames(t8_sorted)=1:length(rownames(t8_sorted))
paste(t8_sorted$gene[1:100],collapse=", ")
t8_MHC=filter(t8,grepl("HLA",gene))
```


```{r}

sort_paste=function(findMarkersLike_output){
  sorted=findMarkersLike_output[order(findMarkersLike_output$p_val),]
  rownames(sorted)=1:length(rownames(sorted))
  filtered=sorted[sorted$avg_log2FC>0&sorted$p_val<0.05,]
  filtered_=sorted[sorted$avg_log2FC<0&sorted$p_val<0.05,]
  pasted=paste(filtered$gene,collapse=", ")
  pasted_=paste(filtered_$gene,collapse=", ")
  print(paste0("pasted, log2FC>0:",pasted))
  print(paste0("pasted, log2FC<0:",pasted_))
  return(list(filtered, filtered_))
}


```


```{r}
A=sort_paste(t4)
t4_filtered=A[[1]]
t4_filtered_=A[[2]]
A8=sort_paste(t8)
```


```{r}
merged_df$HLA=rowMeans(merged_df[which(grepl("HLA",colnames(merged_df)))])
merged_df$HLAD=rowMeans(merged_df[which(grepl("HLA-D",colnames(merged_df)))])
merged_df$CpR=sp$CpR

boxplot1 <- ggplot(merged_df, aes(x = Responder, y = HLA)) +
  geom_boxplot(fill = "lightblue") +
  stat_compare_means(method = "t.test") +
  labs(title = "Boxplot with p-value")

boxplot2 <- ggplot(merged_df, aes(x = CpR, y = HLA)) +
  geom_boxplot(fill = "lightblue") +
  stat_compare_means(method = "t.test") +
  labs(title = "Boxplot with p-value")

boxplot3 <- ggplot(merged_df, aes(x = Responder, y = HLAD)) +
  geom_boxplot(fill = "lightblue") +
  stat_compare_means(method = "t.test") +
  labs(title = "Boxplot with p-value")


boxplot4 <- ggplot(merged_df, aes(x = CpR, y = HLAD)) +
  geom_boxplot(fill = "lightblue") +
  stat_compare_means(method = "t.test") +
  labs(title = "Boxplot with p-value")


```


```{r}
v1="VHL"
v2="HIF1A"
print(ggplot(merged_df, aes(x = !!sym(v1), y = HLA)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = v1, y = "HLA") +
  theme_minimal())

ggplot(merged_df[merged_df$`CK+`=="True",], aes(x = !!sym(v1), y = HLA)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = v1, y = "HLA") +
  theme_minimal()

ggplot(merged_df[merged_df$`SMA+`=="True",], aes(x = !!sym(v1), y = HLA)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = v1, y = "HLA") +
  theme_minimal()

ggplot(merged_df, aes(x = !!sym(v2), y = HLA)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = v2, y = "HLA") +
  theme_minimal()

ggplot(merged_df[merged_df$`CK+`=="True",], aes(x = !!sym(v2), y = HLA)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = v2, y = "HLA") +
  theme_minimal()

ggplot(merged_df[merged_df$`SMA+`=="True",], aes(x = !!sym(v2), y = HLA)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = v2, y = "HLA") +
  theme_minimal()
```
#SCTransform
```{r}
# library(Seurat)
# library(dplyr)
# library(tidyr)

# 예: bio_data_filtered를 tibble에서 data.frame으로 변환(Seurat 호환 위해)
df <- as.data.frame(bio_data_qc)

# 1) gene metadata 따로 추출
gene_meta <- df[, 1:3]  # ProbeDisplayName, TargetName, HUGOSymbol 등

# 2) count data만 추출
count_data <- df[, 4:ncol(df)]

# 3) rownames를 유전자 이름으로 지정(필요에 따라 선택)
rownames(count_data) <- gene_meta$HUGOSymbol
# 또는 ProbeDisplayName 등의 유일한 식별자 사용

# 만약 AOI의 이름이 너무 복잡하면 컬럼명을 단순화(선택 사항)
colnames(count_data) <- gsub("20240820_TMA \\| ", "", colnames(count_data)) 
# 위는 예시로, 불필요한 문자열 제거

# Seurat 오브젝트 만들기
# 여기서 min.cells, min.features 등은 선택적 설정
sce <- CreateSeuratObject(
  counts = count_data,
  min.cells = 0,
  min.features = 0,
  project = "GeoMx_SCT"
)

# 예: library_size만 회귀에서 제거(정규화)하고 싶다고 가정
sce <- SCTransform(
  sce,
  assay = "RNA",
  new.assay.name = "SCT",
  vars.to.regress = c("nCount_RNA"),  # area, nucleiCount 등 추가 가능
  return.only.var.genes = FALSE,        # Pearson residual로부터 variable gene 선정 가능
  verbose = TRUE
)


# (1) Variable feature 재선정 (선택적)
# sce <- FindVariableFeatures(sce, assay = "SCT", nfeatures = 3000)

# (2) PCA / UMAP 등 차원축소
sce <- RunPCA(sce, assay = "SCT")
sce <- RunUMAP(sce, dims = 1:30)

# (3) 클러스터링
sce <- FindNeighbors(sce, dims = 1:30)
sce <- FindClusters(sce, resolution = 1.5)



```

## Metadata
설명
patient, response, vhl, ck, sma, cd45, aoi: basic.
tme: ck-, sma-, cd45+를 더함. (로직: !sce$ck이거나, sce$sma이거나, sce$cd45 이 NA면 tumor이고, 그렇지 않으면 TME다.
 - 이는 NA | F 는 NA이기 때문임. ck+일 경우 !sce$ck는 F이면서 sce$sma, sce$cd45는 NA가 되어 NA를 output한다. 그러나 ck-이거나, sma+이거나 cd45+면 저 셋 중 하나의 값이 T가 되어 T를 output한다.)
tumor_site: near_CAF와 Core를 구분, set 1에서만 사용하는데 그 이유는 set 2에서는 ROI를 큼직큼직하게 잡아서 구분이 무의미함. 

### 기본적인 것들
```{r}
sce$patient=SP$patient
sce$response=as.factor(SP$response)
sce$vhl=as.factor(SP$vhl)
sce$ck=as.logical(SP$`ck+`)
sce$sma=as.logical(SP$`sma+`)
sce$cd45=as.logical(SP$cd45)
sce$roi=paste0(SP$ScanLabel,SP$ROILabel)
sce$aoi=case_when(
  sce$ck ~ "CK+",
  !sce$ck ~ "CK-",
  sce$sma ~ "SMA+",
  !sce$sma ~ "SMA-",
  sce$cd45 ~ "CD45",
  TRUE ~ "nothing" # 기본값
)
sce$tme=ifelse(is.na(!sce$ck|!sce$sma|sce$cd45),F,T)
```

### tumor site
```{r}

# AOI 메타데이터를 Seurat 오브젝트에 추가
# (library size 등을 meta.data로 넣어서 회귀 공변량으로 사용 가능)
#sce@meta.data$library_size <- colSums(sce@assays$RNA@layers$counts) #sce$nCount_RNA와 같아서 할 필요가..
# 또는 sce@meta.data$area <- aoi_meta$area
#     sce@meta.data$nuclei <- aoi_meta$nucleiCount
##day1
tumor_site=c(rep(NA,length(sce$orig.ident)))
tumor_site[18+c(1, 2, 3, 7, 10, 11, 13, 15, 17, 19)]="near_CAF"
tumor_site[18+c(4,5,6,9, 12, 14, 16, 18, 20, 28)]="core" #22, 29가 없음. 따라서 30번 ROI -> 28이 되어야 함.
##day2
# tumor_site[46+c(1:19)]="near_CAF"
# tumor_site[46+17]="core"
sce$tumor_site=tumor_site

SP$response_=ifelse(SP$response==3,T,F)
sce$response_=SP$response_
SP$response__=ifelse(SP$response==1,F,T)
sce$response__=SP$response__
sce$aoi_r=case_when(
  sce$ck&sce$response_ ~ "CK+R",
  sce$ck& !sce$response_ ~ "CK+NR",
  !sce$ck & sce$response_ ~ "CK-R",
  !sce$ck & !sce$response_ ~ "CK-NR",
  sce$sma & sce$response_  ~ "SMA+R",
  sce$sma & !sce$response_  ~ "SMA+NR",
  !sce$sma & sce$response_  ~ "SMA-R",
  !sce$sma & !sce$response_ ~ "SMA-NR",
  sce$cd45 ~ "CD45",
  TRUE ~ "nothing" # 기본값
)
sce$aoi_rr=case_when(
  sce$tumor_site=="core" ~ "CK+core",
  sce$tumor_site=="near_CAF" ~ "CK+nearCAF",
  TRUE ~ sce$aoi
)

sce$AOI=case_when(
  sce$tme ~ "TME",
  sce$sma ~ "SMA+",
  sce$ck ~ "CK+",
  TRUE ~ "nothing"
)

sce$AOI_r=case_when(
  sce$AOI=="TME" & sce$response_ ~ "TME_R",
  sce$AOI=="TME" & !sce$response_ ~ "TME_NR",
  sce$AOI=="CK+" & sce$response_ ~ "CK+R",
  sce$AOI=="CK+" & !sce$response_ ~ "CK+NR",
  sce$AOI=="SMA+" & sce$response_ ~ "SMA+R",
  sce$AOI=="SMA+" & !sce$response_ ~ "SMA+NR",
  TRUE ~ "nothing"
)

sce$AOI_r=case_when(
  sce$AOI%in%c("TME","SMA+") & sce$response_ ~ "TME - Response",
  sce$AOI%in%c("TME","SMA+") & !sce$response_ ~ "TME - NonResponse",
  sce$AOI=="CK+" & sce$response_ ~ "Cancer cell - Response",
  sce$AOI=="CK+" & !sce$response_ ~ "Cancer cell - NonResponse",
  TRUE ~ "nothing"
)

```
### mutation

```{r}
sce$mut=case_when(
  sce$patient%in%c(2,4,5,6,7,9,10) ~ "mut",
  sce$patient==3 ~ "wt",
  TRUE ~ NA
)
```

### TME's corresponding CK's HIF_pos_Q value - in all
```{r}
sce_day2_ck=subset(sce_day2,ck==T)
quartile_breaks1_=quantile(sce_day2_ck$HIF_pos,probs=seq(0,1,0.25),na.rm=T)
sce_day2_ck$HIF_pos_Q_by_ck <- cut(sce_day2_ck$HIF_pos, 
                            breaks = quartile_breaks1_, 
                            labels = c("Q1", "Q2", "Q3", "Q4"), 
                            include.lowest = TRUE)
# Step 1: roi_1, roi_2, roi_3, roi_4 추출
roi_1 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q1"]
roi_2 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q2"]
roi_3 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q3"]
roi_4 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q4"]

# Step 2: sce_day2$tme == TRUE인 세포들의 tme_near_ck_hif 설정
sce_day2$tme_near_ck_hif <- NA  # 초기화 (기본적으로 NA)

sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_1] <- "Q1"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_2] <- "Q2"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_3] <- "Q3"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_4] <- "Q4"

# 결과 확인
table(sce_day2$tme_near_ck_hif, useNA = "always")

myhm_genesets2(sce_day2,group="tme_near_ck_hif",gene_sets=list("MHC Class I molecules"=mhc1_genes,"MHC class II molecules"=mhc2_genes,"HIF1A signature"=HIF_pos), title = "Normalize Gene Set Signature -\nTME - Leveled by their Corresponding Cancer cell's HIF1A Signature", x_label = "TME - Correspoding Cancer cell's HIF1A Quartile")
myhm_genes2(sce_day2,group="tme_near_ck_hif",genes=c("MHC Class I molecules"=mhc1_genes,"MHC class II molecules"=mhc2_genes,"HIF1A signature"=HIF_pos), title = "Normalize Gene Set Signature -\nTME - Leveled by their Corresponding Cancer cell's HIF1A Signature", x_label = "TME - Correspoding Cancer cell's HIF1A Quartile")
```

### TME's corresponding CK's HIF_pos_T value - in all
```{r}
sce_day2_ck=subset(sce_day2,ck==T)
quartile_breaks1_T=quantile(sce_day2_ck$HIF_pos,probs=seq(0,1,1/3),na.rm=T)
sce_day2_ck$HIF_pos_Q_by_ck <- cut(sce_day2_ck$HIF_pos, 
                            breaks = quartile_breaks1_T, 
                            labels = c("Q1", "Q2", "Q3"), 
                            include.lowest = TRUE)
# Step 1: roi_1, roi_2, roi_3, roi_4 추출
roi_1 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q1"]
roi_2 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q2"]
roi_3 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q3"]
# roi_4 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q4"]

# Step 2: sce_day2$tme == TRUE인 세포들의 tme_near_ck_hif 설정
sce_day2$tme_near_ck_hif <- NA  # 초기화 (기본적으로 NA)

sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_1] <- "Q1"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_2] <- "Q2"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_3] <- "Q3"
# sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_4] <- "Q4"

# 결과 확인
table(sce_day2$tme_near_ck_hif, useNA = "always")

myhm_genesets2(sce_day2,group="tme_near_ck_hif",gene_sets=list("MHC Class I molecules"=mhc1_genes,"MHC class II molecules"=mhc2_genes,"HIF1A signature"=HIF_pos), title = "Normalize Gene Set Signature -\nTME - Leveled by their Corresponding Cancer cell's HIF1A Signature", x_label = "TME - Correspoding Cancer cell's HIF1A Quartile")
myhm_genes2(sce_day2,group="tme_near_ck_hif",genes=c("MHC Class I molecules"=mhc1_genes,"MHC class II molecules"=mhc2_genes,"HIF1A signature"=HIF_pos), title = "Normalize Gene Set Signature -\nTME - Leveled by their Corresponding Cancer cell's HIF1A Signature", x_label = "TME - Correspoding Cancer cell's HIF1A Quartile")
```

### TME's corresponding CK's HIF_pos_Q value
```{r}
sce_day2_ck=subset(sce_day2,ck==T)
quartile_breaks1_=quantile(sce_day2_ck$HIF_pos,probs=seq(0,1,0.25),na.rm=T)
sce_day2_ck$HIF_pos_Q_by_ck <- cut(sce_day2_ck$HIF_pos, 
                            breaks = quartile_breaks1_, 
                            labels = c("Q1", "Q2", "Q3", "Q4"), 
                            include.lowest = TRUE)
# Step 1: roi_1, roi_2, roi_3, roi_4 추출
roi_1 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q1"]
roi_2 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q2"]
roi_3 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q3"]
roi_4 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q4"]

# Step 2: sce_day2$tme == TRUE인 세포들의 tme_near_ck_hif 설정
sce_day2$tme_near_ck_hif <- NA  # 초기화 (기본적으로 NA)

sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_1] <- "Q1"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_2] <- "Q2"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_3] <- "Q3"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_4] <- "Q4"

# 결과 확인
table(sce_day2$tme_near_ck_hif, useNA = "always")

myhm_genesets2(sce_day2,group="tme_near_ck_hif",gene_sets=list("MHC Class I molecules"=mhc1_genes,"MHC class II molecules"=mhc2_genes,"HIF1A signature"=HIF_pos), title = "Normalize Gene Set Signature -\nTME - Leveled by their Corresponding Cancer cell's HIF1A Signature", x_label = "TME - Correspoding Cancer cell's HIF1A Quartile")
myhm_genes2(sce_day2,group="tme_near_ck_hif",genes=c("MHC Class I molecules"=mhc1_genes,"MHC class II molecules"=mhc2_genes,"HIF1A signature"=HIF_pos), title = "Normalize Gene Set Signature -\nTME - Leveled by their Corresponding Cancer cell's HIF1A Signature", x_label = "TME - Correspoding Cancer cell's HIF1A Quartile")
```
### TME's corresponding CK's HIF_pos_T value
```{r}
sce_day2_ck=subset(sce_day2,ck==T)
quartile_breaks1_T=quantile(sce_day2_ck$HIF_pos,probs=seq(0,1,1/3),na.rm=T)
sce_day2_ck$HIF_pos_Q_by_ck <- cut(sce_day2_ck$HIF_pos, 
                            breaks = quartile_breaks1_T, 
                            labels = c("Q1", "Q2", "Q3"), 
                            include.lowest = TRUE)
# Step 1: roi_1, roi_2, roi_3, roi_4 추출
roi_1 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q1"]
roi_2 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q2"]
roi_3 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q3"]
# roi_4 <- sce_day2_ck$roi[sce_day2_ck$ck == TRUE & sce_day2_ck$HIF_pos_Q_by_ck == "Q4"]

# Step 2: sce_day2$tme == TRUE인 세포들의 tme_near_ck_hif 설정
sce_day2$tme_near_ck_hif <- NA  # 초기화 (기본적으로 NA)

sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_1] <- "Q1"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_2] <- "Q2"
sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_3] <- "Q3"
# sce_day2$tme_near_ck_hif[sce_day2$tme == TRUE & sce_day2$roi %in% roi_4] <- "Q4"

# 결과 확인
table(sce_day2$tme_near_ck_hif, useNA = "always")

myhm_genesets2(sce_day2,group="tme_near_ck_hif",gene_sets=list("MHC Class I molecules"=mhc1_genes,"MHC class II molecules"=mhc2_genes,"HIF1A signature"=HIF_pos), title = "Normalize Gene Set Signature -\nTME - Leveled by their Corresponding Cancer cell's HIF1A Signature", x_label = "TME - Correspoding Cancer cell's HIF1A Quartile")
myhm_genes2(sce_day2,group="tme_near_ck_hif",genes=c("MHC Class I molecules"=mhc1_genes,"MHC class II molecules"=mhc2_genes,"HIF1A signature"=HIF_pos), title = "Normalize Gene Set Signature -\nTME - Leveled by their Corresponding Cancer cell's HIF1A Signature", x_label = "TME - Correspoding Cancer cell's HIF1A Quartile")

myhm_genes2(sce_day2,group="tme_near_ck_hif",genes=genes_of_interest, title = "Normalize Gene Set Signature -\nTME - Leveled by their Corresponding Cancer cell's HIF1A Signature", x_label = "TME - Correspoding Cancer cell's HIF1A Quartile")
```


## AddModule?
```{r}
g1=unlist(G_rcc[1:5])
g2=unlist(G_rcc[6:8])
g3=unlist(G_rcc[9:17])
g4=unlist(G_rcc[18])
g5=unlist(G_rcc[19:21])
immune_checkpoint_genes <- c("TLR3", "CD8", "CD68", "HMGA1", "NUP62", "ARHGAP42", 
                             "CD276", "HLA-E", "LGALS9", "TNFRSF18", 
                             "PBRM1", "FGF17", "PRKCG", "SSTR1", "SCTR", 
                             "TNFSF15") #The following requested variables were not found: CD8, LGALS9, SSTR1, TNFSF15
#CD4; 
mhc2_genes <- grep("^HLA-D(?!$)", rownames(sce), value = TRUE, perl = TRUE)

feature_avg1=rowMeans(FetchData(sce,vars=g1))
feature_avg2=rowMeans(FetchData(sce,vars=g2))
feature_avg3=rowMeans(FetchData(sce,vars=g3))
feature_avg4=rowMeans(FetchData(sce,vars=g4))
feature_avg5=rowMeans(FetchData(sce,vars=g5))
feature_avg6=rowMeans(FetchData(sce,vars=immune_checkpoint_genes))
feature_avg7=rowMeans(FetchData(sce,vars=mhc1_genes))
feature_avg8=rowMeans(FetchData(sce,vars=mhc2_genes))
feature_avg9=rowMeans(FetchData(sce,vars=HIF_pos))
feature_avg10=rowMeans(FetchData(sce,vars=HIF_neg))
feature_avg11=rowMeans(FetchData(sce,vars=HIF_neg))
feature_avg12=rowMeans(FetchData(sce,vars=c(mhc1_genes,mhc2_genes)))
feature_avg13=rowMeans(FetchData(sce,vars=HIF2_pos_genes))


sce=AddMetaData(sce,metadata=feature_avg1,col.name="tumor")
sce=AddMetaData(sce,metadata=feature_avg2,col.name="CAF")
sce=AddMetaData(sce,metadata=feature_avg3,col.name="immune")
sce=AddMetaData(sce,metadata=feature_avg4,col.name="endo")
sce=AddMetaData(sce,metadata=feature_avg5,col.name="stromal")
sce=AddMetaData(sce,metadata=feature_avg6,col.name="ICIR genes")
sce=AddMetaData(sce,metadata=feature_avg7,col.name="mhc1_genes")
sce=AddMetaData(sce,metadata=feature_avg8,col.name="mhc2_genes")
sce=AddMetaData(sce,metadata=feature_avg9,col.name="HIF_pos")
sce=AddMetaData(sce,metadata=feature_avg10,col.name="HIF_neg")
sce=AddMetaData(sce,metadata=feature_avg11,col.name="POSTN_pos")
sce=AddMetaData(sce,metadata=feature_avg12,col.name="MHC_genes")
sce=AddMetaData(sce,metadata=feature_avg13,col.name="HIF2A_pos")


quartile_breaks1=quantile(sce$HIF_pos,probs=seq(0,1,0.25),na.rm=T)
quartile_breaks2=quantile(sce$mhc1_genes,probs=seq(0,1,0.25),na.rm=T)
quartile_breaks3=quantile(sce$mhc2_genes,probs=seq(0,1,0.25),na.rm=T)
quartile_breaks4=quantile(sce$POSTN_pos,probs=seq(0,1,0.25),na.rm=T)
quartile_breaks5=quantile(sce$MHC,probs=seq(0,1,0.25),na.rm=T)
quartile_breaks6=quantile(sce$HIF_pos,probs=seq(0,1,1/3),na.rm=T)

sce$HIF_pos_Q <- cut(sce$HIF_pos, 
                            breaks = quartile_breaks1, 
                            labels = c("Q1", "Q2", "Q3", "Q4"), 
                            include.lowest = TRUE)
sce$mhc1_Q <- cut(sce$mhc1_genes, 
                            breaks = quartile_breaks2, 
                            labels = c("Q1", "Q2", "Q3", "Q4"), 
                            include.lowest = TRUE)
sce$mhc2_Q <- cut(sce$mhc2_genes, 
                            breaks = quartile_breaks3, 
                            labels = c("Q1", "Q2", "Q3", "Q4"), 
                            include.lowest = TRUE)
sce$POSTN_pos_Q <- cut(sce$POSTN_pos, 
                            breaks = quartile_breaks4, 
                            labels = c("Q1", "Q2", "Q3", "Q4"), 
                            include.lowest = TRUE)
sce$MHC=cut(sce$MHC, 
                            breaks = quartile_breaks4, 
                            labels = c("Q1", "Q2", "Q3", "Q4"), 
                            include.lowest = TRUE)
sce$HIF_pos_T <- cut(sce$HIF_pos, 
                            breaks = quartile_breaks6, 
                            labels = c("Q1", "Q2", "Q3"), 
                            include.lowest = TRUE)
```

## subsetting
```{r}
sct_count=sce@assays$SCT@scale.data

sce_ck=subset(sce,subset=ck==T)
sce_sma=subset(sce,subset=sma==T)
sce_tme=subset(sce,subset=tme==T)
#sce_cd45=subset(sce,subset=cd45==T)
sce_ckn=subset(sce,subset=ck==F)
sce_sman=subset(sce,subset=sma==F)
sce_day2=subset(sce,no>=47)
sce_list=list(sce,sce_ck,sce_sma,sce_tme,sce_ckn,sce_sman)
```
## Seurat plots

### DimPlot
```{r}

DimPlot(sce,group.by="seurat_clusters") + ggtitle("Group.by Seurat_clusters")
DimPlot(sce,group.by="response")+ ggtitle("Group.by response")
DimPlot(sce,group.by="aoi")+ ggtitle("Group.by aoi")
DimPlot(sce,group.by="vhl")+ ggtitle("Group.by vhl")
```


### VlnPlot
```{r}
VlnPlot(sce,features=c("tumor","CAF","immune","endo","stromal"),group.by="aoi")
VlnPlot(sce,features=c("tumor","CAF","immune","endo","stromal"),group.by="seurat_clusters")
VlnPlot(sce,features=unlist(G_rcc[6:8]),group.by="aoi")
VlnPlot(sce,features=c(G_rcc$immune_M1_macrophages,G_rcc$immune_M2_macrophages),group.by="aoi")

vlnplot=function(sobj,features,group.by){
  VlnPlot(sobj,features=features,group.by=group.by)+ggtitle(paste0(deparse(substitute(sobj))," ",features," ",group.by))
}

VlnPlot(sce_ck,features = "HIF_pos",group.by="response")
VlnPlot(sce_sma,features = "HIF_pos",group.by="response")
VlnPlot(sce_tme,features = "HIF_pos",group.by="response")

VlnPlot(sce_ck,features =HIF_pos,group.by="response")
VlnPlot(sce_sma,features = HIF_pos,group.by="response")
VlnPlot(sce_tme,features = HIF_pos,group.by="response")

vlnplot(sce_ck,"HIF_pos","vhl")
vlnplot(sce_ck,"HIF_neg","vhl")
vlnplot(sce_ck,"mhc2_genes","vhl")

vlnplot(sce_sma,"HIF_pos","vhl")
vlnplot(sce_sma,"HIF_neg","vhl")
vlnplot(sce_sma,"mhc2_genes","vhl")

vlnplot(sce_tme,"HIF_pos","vhl")
vlnplot(sce_tme,"HIF_neg","vhl")
vlnplot(sce_tme,"mhc2_genes","vhl")
```

### heatmap
```{r}
# myhm_genesets(sce,gene_sets = G_rcc)
# myhm_genesets(sce,gene_sets = G_rcc,group="aoi")
myhm_genesets2(sce,gene_sets = G_rcc,group="aoi")
myhm_genesets2(sce,gene_sets = G_rcc,group="AOI")
myhm_genesets2(sce,gene_sets = G_rcc[c(1:7,9:14,17:19,21)],group="AOI")
myhm_genesets2(sce,gene_sets = G_rcc[c(1:7,9:14,17:19,21)],group="AOI_r")

#myhm_genes2(sce,genes=c("FAP"),group="aoi")
myhm_genes2(sce,genes=unlist(G_rcc[1:5]),group="aoi")
myhm_genes2(sce,genes=unlist(G_rcc[6:8]),group="aoi")
myhm_genes2(sce,genes=unlist(G_rcc[9:17]),group="aoi")


myhm_genesets2(sce,gene_sets =rcc_review,group="aoi_r")
myhm_genes2(sce,genes=rcc_review$emt_markers,group="aoi_r")
myhm_genes2(sce,genes=rcc_review$macrophage_fibroblast_markers,group="aoi_r")
myhm_genes2(sce,genes=rcc_review$hyaline_stroma_markers,group="aoi_r")
myhm_genes2(sce,genes=rcc_review$tls_markers,group="aoi_r")



myhm_genes2(sce_ck,genes=rcc_review$emt_markers,group="aoi_r")

myhm_genes2(sce,genes=unlist(G_rcc[1:5]),group="aoi_r")
myhm_genes2(sce,genes=unlist(G_rcc[6:8]),group="aoi_r")
myhm_genes2(sce,genes=unlist(G_rcc[9:17]),group="aoi_r")

# g1=unlist(G_rcc[1:5])
# g2=unlist(G_rcc[6:8])
# g3=unlist(G_rcc[9:17])
# g4=unlist(G_rcc[18])
# g5=unlist(G_rcc[19:21])
myhm_genes2(sce,genes=immune_checkpoint_genes,group="aoi_r")

myhm_genes2(sce,genes=mhc_genes, group="aoi_r")

myhm_genes2(sce,genes=c("YES1","LAG3","HAVCR2"))
```
#### 250130
##### vhl
```{r}

myhm_genes2(sce,genes=HIF_pos,group="vhl")
myhm_genes2(sce,genes=HIF_neg,group="vhl")
myhm_genes2(sce,genes=mhc2_genes,group="vhl")

myhm_genes2(sce_ck,genes=HIF_pos,group="vhl")
myhm_genes2(sce_ck,genes=HIF_neg,group="vhl")
myhm_genes2(sce_ck,genes=mhc2_genes,group="vhl")

myhm_genes2(sce_sma,genes=HIF_pos,group="vhl")
myhm_genes2(sce_sma,genes=HIF_neg,group="vhl")
myhm_genes2(sce_sma,genes=mhc2_genes,group="vhl")

myhm_genes2(sce_tme,genes=HIF_pos,group="vhl")
myhm_genes2(sce_tme,genes=HIF_neg,group="vhl")
myhm_genes2(sce_tme,genes=mhc2_genes,group="vhl")

```
##### response
```{r}

myhm_genes2(sce,genes=HIF_pos,group="response")
myhm_genes2(sce,genes=HIF_neg,group="response")
myhm_genes2(sce,genes=mhc2_genes,group="response")

myhm_genes2(sce_ck,genes=HIF_pos,group="response")
myhm_genes2(sce_ck,genes=HIF_neg,group="response")
myhm_genes2(sce_ck,genes=mhc2_genes,group="response")

myhm_genes2(sce_sma,genes=HIF_pos,group="response")
myhm_genes2(sce_sma,genes=HIF_neg,group="response")
myhm_genes2(sce_sma,genes=mhc2_genes,group="response")

myhm_genes2(sce_tme,genes=HIF_pos,group="response")
myhm_genes2(sce_tme,genes=HIF_neg,group="response")
myhm_genes2(sce_tme,genes=mhc2_genes,group="response")

```
##### HIF_pos_quartile
```{r}
myhm_genes2(sce,genes=HIF_pos,group="HIF_pos_quartile")
myhm_genes2(sce,genes=HIF_neg,group="HIF_pos_quartile")
myhm_genes2(sce,genes=mhc2_genes,group="HIF_pos_quartile")

myhm_genes2(sce_ck,genes=HIF_pos,group="HIF_pos_quartile")
myhm_genes2(sce_ck,genes=HIF_neg,group="HIF_pos_quartile")
myhm_genes2(sce_ck,genes=mhc2_genes,group="HIF_pos_quartile")

myhm_genes2(sce_sma,genes=HIF_pos,group="HIF_pos_quartile")
myhm_genes2(sce_sma,genes=HIF_neg,group="HIF_pos_quartile")
myhm_genes2(sce_sma,genes=mhc2_genes,group="HIF_pos_quartile")

myhm_genes2(sce_tme,genes=HIF_pos,group="HIF_pos_quartile")
myhm_genes2(sce_tme,genes=HIF_neg,group="HIF_pos_quartile")
myhm_genes2(sce_tme,genes=mhc2_genes,group="HIF_pos_quartile")
```

##### rcc_review
```{r}
myhm_genesets2(sce,group="vhl",gene_sets=rcc_review)

myhm_genesets2(sce,group="HIF_pos_quartile",gene_sets=rcc_review)

myhm_genes2(sce_tme,group="HIF_pos_quartile",genes = rcc_review$emt_markers)
```

## findmarkers
```{r}
Idents(sce_ck)="response"
fm_ck_RNR=FindMarkers(sce_ck, ident.1=3)
fm_ck_NRR=FindMarkers(sce_ck, ident.1=1)

Idents(sce_sma)="response"
fm_sma_RNR=FindMarkers(sce_sma, ident.1=3)
fm_sma_NRR=FindMarkers(sce_sma, ident.1=1)

Idents(sce_sman)="response"
fm_sman_RNR=FindMarkers(sce_sman, ident.1=3)
fm_sman_NRR=FindMarkers(sce_sman, ident.1=1)

Idents(sce_tme)="response"
fm_tme_RNR=FindMarkers(sce_tme,ident.1=3)
fm_tme_NRR=FindMarkers(sce_tme,ident.1=1)

Idents(sce_ckn)="response"
fm_ckn_RNR=FindMarkers(sce_ckn,ident.1=3)
fm_ckn_NRR=FindMarkers(sce_ckn,ident.1=1)

Idents(sce_ck)="tumor_site"
fm_tumorsite=FindMarkers(sce_ck,ident.1="near_CAF",ident.2="core")
fm_tumorsite$gene=rownames(fm_tumorsite)
fm_tumorsite_filters=fm_tumorsite[fm_tumorsite$gene%in%c("CCN1","CCN2","SERPINE1","VEGFA","CD274","PDGFRA","PDGFRB","CXCL8"),]

Idents(sce_ck)="vhl"
fm_ck_vhlh=FindMarkers(sce_ck,ident.1=3)

i=0
for(fm in list(fm_ck_RNR,fm_ck_NRR,fm_sma_RNR,fm_sma_NRR,fm_tme_RNR,fm_tme_NRR,fm_ckn_RNR,fm_ckn_NRR)){
  i=i+1
  write.csv(fm, file = paste0("fm",i,".csv"))
}
```
### DEGs - positive, negative
```{r}
for(fm in list(fm_ck_RNR,fm_ck_NRR,fm_sma_RNR,fm_sma_NRR,fm_tme_RNR,fm_tme_NRR,fm_ckn_RNR,fm_ckn_NRR)){
  my_(fm)
}
```
### DEG - 250130 - VHL 1, 2, 3, response 1, 2, 3
```{r}
Idents(sce_ck)="vhl"
fmckv1=FindMarkers(sce_ck,1)
fmckv3=FindMarkers(sce_ck,3)

Idents(sce_sma)="vhl"
#fmsmav1=FindMarkers(sce_sma,1)
fmsmav3=FindMarkers(sce_sma,3)

Idents(sce_tme)="vhl"
fmtmev1=FindMarkers(sce_tme,1)
fmtmev3=FindMarkers(sce_tme,3)

Idents(sce_ck)="response"
fmckr1=FindMarkers(sce_ck,1)
fmckr3=FindMarkers(sce_ck,3)

Idents(sce_sma)="response"
fmsmar1=FindMarkers(sce_sma,1)
fmsmar3=FindMarkers(sce_sma,3)

Idents(sce_tme)="response"
fmtmer1=FindMarkers(sce_tme,1)
fmtmer3=FindMarkers(sce_tme,3)

for(tissue in c("ck","sma","tme")){
  for(pattern in c("v1", "v3","r1","r3")){
    try({fm_object=get(paste0("fm",tissue,pattern))})
    assign(paste0("fm",tissue,pattern,"p"),fm_object[fm_object$avg_log2FC>0,])
    assign(paste0("fm",tissue,pattern,"n"),fm_object[fm_object$avg_log2FC<0,])
  }
}

for(fm in ls()[grepl("fm",ls())]){
  fm_name=fm
  fm_object=get(fm)
  fm_object$gene=rownames(fm_object)
  assign(fm_name,fm_object)
}

paste(rownames(fmtmev3p[1:100,]), collapse = ", ")

Idents(sce)="HIF_pos_quartile"
fmhif=FindMarkers(sce,ident.1 = "Q4",ident.2="Q1")
fmhif$gene=rownames(fmhif)

Idents(sce_ck)="HIF_pos_quartile"
fmckhif=FindMarkers(sce_ck,ident.1 = "Q4",ident.2="Q1")
fmckhif$gene=rownames(fmhif)


Idents(sce_sma)="HIF_pos_quartile"
fmsmahif=FindMarkers(sce_sma,ident.1 = "Q4",ident.2="Q1")

Idents(sce_tme)="HIF_pos_quartile"
fmtmehif=FindMarkers(sce_tme,ident.1 = "Q4",ident.2="Q1")

Idents(sce)="mut"
Idents(sce_ck)="mut"
Idents(sce_sma)="mut"
Idents(sce_tme)="mut"
fmmut=FindMarkers(sce,ident.1="wt",ident.2="mut")
fmmutck=FindMarkers(sce_ck,ident.1="wt",ident.2="mut")
fmmutsma=FindMarkers(sce_sma,ident.1="wt",ident.2="mut")
fmmuttme=FindMarkers(sce_tme,ident.1="wt",ident.2="mut")

```

#### GSEA
```{r}
gsea1=my_gsea(fmckv3)
gsea2=my_gsea(fmsmav3)
# gsea3=my_gsea(fmtmev3)
gsea4=my_gsea(fmhif)
gsea5=my_gsea(fmckhif)

setwd("/data/kjc1/projects/#112.RCC")
saveRDS(gsea1,"gsea_ck_vhlhigh.rds")
saveRDS(gsea2,"gsea_sma_vhlhigh.rds")
# saveRDS(gsea3,"gsea_tme_vhlhigh.rds")
saveRDS(gsea4,"gsea_all_hifhigh.rds")
saveRDS(gsea5,"gsea_ck_hifhigh.rds")
# saveRDS(fmhif,"DEG_all_aois_HIFQ4vsQ1.rds")
# saveRDS(fmckhif,"DEG_ck_HIFQ4vsQ1.rds")
write.csv(fmckhif,"deg_ck_hif.csv")
write.csv(fmhif,"deg_all_hif.csv")



write.csv(fmckv3, file="deg_ck_vhl_high.csv")
write.csv(fmsmav3, file="deg_sma_vhl_high.csv")
write.csv(fmtmev3, file="deg_tme_vhl_high.csv")
write.csv(fmckr3, file="deg_ck_RvsNR.csv")
write.csv(fmsmar3, file="deg_sma_RvsNR.csv")
write.csv(fmtmer3, file="deg_tme_RvsNR.csv")
```



# Corr heatmap

## pheatmap
```{r}
#genes_of_interest=c("VHL","YAP1","CTGF","CYR61","AREG","MYC","GLI2","VIMENTIN","AXL","FRAS1","FBLN5","ERBB3") #YAP related
#genes_of_interest=c("VHL","FYN", "YES", "LCK", "LYN", "HCK", "FGR","BLK") #src related
#genes_of_interest=c("VHL",rownames(count_data)[1:10]) #random
#genes_of_interest=c("VHL","CCN1","CCN2","CCN3","CCN4","CCN5","CCN6","SERPINE1","SERPINE2","SERPINE3","VEGFA","VEGFB","VEGFC","VEGFD") #CYR61, CTGF, PAI1, VEGF

g1=c("VHL","YAP1","CTGF","CYR61","AREG","MYC","GLI2","VIMENTIN","AXL","FRAS1","FBLN5","ERBB3") #YAP related
g2=c("VHL","FYN", "YES", "LCK", "LYN", "HCK", "FGR","BLK") #src related
gr=c("VHL",rownames(count_data)[1:10]) #random
g3=c("VHL","CCN1","CCN2","CCN3","CCN4","CCN5","CCN6","SERPINE1","SERPINE2","SERPINE3","VEGFA","VEGFB","VEGFC","VEGFD") #CYR61, CTGF, PAI1, VEGF
g4=c("VHL","HIF1A",hif1a_targets)

genes_of_interest=g4
heat_list=list()

for(sce_name in names(list(sce_ck,sce_tme))){
  gene_data=sce_list[[sce_name]]@assays$SCT@scale.data[rownames(count_data)%in%genes_of_interest,] #normalized
  #gene_data=count_data[rownames(count_data)%in%genes_of_interest,] #unnormalized
  
  gene_data=t(gene_data)
  
  
  # Pearson 상관계수 계산
  cor_matrix <- cor(gene_data, method = "pearson")
  library(pheatmap)
  library(grid)
  
  
  library(Hmisc)
  
  # 상관계수 및 p-value 계산
  cor_results <- rcorr(as.matrix(gene_data), type = "pearson")  # 또는 "spearman" #Hmisc 패키지의 함수로, 1대신 NA를반환해서 귀찮게함.
  cor_matrix <- cor_results$r      # 상관계수 행렬
  p_matrix <- cor_results$P        # p-value 행렬
  # p-value를 기호로 변환하는 함수 정의
  pval_to_stars <- function(p) {
    if (is.na(p)) return(NA)       # NA 값 처리
    else if (p < 0.001) return("***")
    else if (p < 0.01) return("**")
    else if (p < 0.05) return("*")
    else return("")
  }
  
  # p-value 행렬을 유의성 기호로 변환
  p_stars <- apply(p_matrix, c(1, 2), pval_to_stars)
  heat_list[[sce_name]]=pheatmap(
    cor_matrix,
    main = paste0("sce_name"," Gene Correlation Heatmap"),
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    display_numbers = p_stars,  # 유의성 기호 표시
    color = colorRampPalette(c("blue", "white", "red"))(50)  # 색상 설정
  )
  # 범례 추가
  grid.text(
    label = "***: p < 0.001\n**: p < 0.01\n*: p < 0.05\nns: p ≥ 0.05",
    x = 0.85, y = 0.85,  # 범례 위치 (x, y 비율 값으로 조정)
    just = "left",       # 텍스트 정렬 방식
    gp = gpar(fontsize = 10)  # 글씨 크기 설정
  )
  print(heat_list[[sce_name]])
}
```

## ComplexHeatmap
```{r}
library(ComplexHeatmap)
library(circlize)

# Heatmap 그리기
heatmap <- Heatmap(
  cor_matrix,
  name = "Correlation",
  column_title = "Gene Correlation Heatmap",
  row_title = "Genes",
  col = colorRamp2(c(-1, 0, 1), c("blue", "white", "red")),
  show_row_dend = TRUE,
  show_column_dend = TRUE,
  cell_fun = function(j, i, x, y, width, height, fill) {
    grid.text(p_stars[i, j], x, y)  # 각 셀에 유의성 기호 추가
  }
)

# 범례 객체 생성
legend_annotation <- Legend(
  labels = c("***: p < 0.001", "**: p < 0.01", "*: p < 0.05", "ns: p ≥ 0.05"),
  title = "Significance",
  legend_gp = gpar(fontsize = 10)  # 글씨 크기 설정
)

# Heatmap과 범례 그리기
draw(heatmap, annotation_legend_list = list(legend_annotation))
```

## lineplot, boxplot
```{r}
# VHL 값 추출
vhl_data <- sce@assays$SCT@scale.data["VHL", ]  # "VHL"이 gene 이름이라고 가정
vhl_df <- data.frame(
  AOI = colnames(sce@assays$SCT@scale.data),  # AOI 이름 (열 이름)
  Count = as.numeric(vhl_data)  # VHL 카운트 값
)

vhl_df$vhl=sce$vhl
vhl_df$ck=sce$ck
vhl_df$response=sce$response
# vhl_df=vhl_df[vhl_df$ck=="True",]
# AOI를 값 크기 순으로 정렬
vhl_order=vhl_df[order(vhl_df$vhl),]
rownames(vhl_order)=1:nrow(vhl_order)
vhl_order$order=1:nrow(vhl_order)

# 결과 확인
#print(head(vhl_df))
# Line Plot
ggplot(vhl_order, aes(x = order, y = Count, group = 1)) +
  geom_line(color = "blue", size = 1) +  # 선 그래프
  geom_point(color = "red", size = 2) + # 데이터 포인트 추가
  labs(title = "VHL Expression Across AOIs",
       x = "AOI",
       y = "VHL Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # AOI 이름 회전

# ggplot(merged_df, aes_string(x = "Responder", y = gene)) +
#   geom_boxplot(fill = "lightblue", color = "darkblue") +
#   labs(
#     title = paste("Boxplot of", gene, "by Response"),
#     x = "Response",
#     y = "Gene Expression"
#   ) +
#   theme_minimal()

# ggplot(vhl_order, aes(x = vhl, y = Count)) +
#   geom_boxplot(fill = "lightblue", color = "darkblue") +
#   geom_jitter(width = 0.2, color = "red", size = 1.5, alpha = 0.7) +  # 점 추가 #겹치지않게. geom_point는 정확하게
#   labs(
#     title = paste("Boxplot of", "VHL", "by Response"),
#     x = "Response",
#     y = "Gene Expression"
#   ) +
#   theme_minimal()

```

#통계검정

```{r}

###순위 데이터, 범주변수는 카이제곱

# 카이제곱 검정
chisq_test <- chisq.test(table(vhl_df$vhl, vhl_df$response))
print(chisq_test)

# Mantel-Haenszel Trend Test
mantel_test <- mantelhaen.test(table(vhl_df$vhl, vhl_df$response))
print(mantel_test)

###카운트와 범주변수는 t나 wilcox

# t-test
t_test <- t.test(Count ~ response, data = vhl_df)
print(t_test)

# Wilcoxon Rank-Sum Test
wilcox_test <- wilcox.test(Count ~ response, data = vhl_df)
print(wilcox_test)

vhl_df$response <- ifelse(vhl_df$response == "True", 1, 0)
logistic_model <- glm(response ~ vhl + Count, data = vhl_df, family = "binomial")
summary(logistic_model)
```

## gene-wise normality / homoskedasticity
```{r}
library(parallel)
library(car)

#backup
data_norm_=data_norm


# data_norm=scaled_data_area
data_norm=scaled_data_nuclei
data_norm=data_norm_
# 병렬 처리로 각 유전자 분석
results_parallel <- mclapply(rownames(data_norm), function(gene) {
  gene_data <- data_norm[gene, ]
  sample_groups <- SP$response[match(colnames(data_norm), SP$SegmentDisplayName)]
  
  # Group 변수를 factor로 변환
  gene_df <- data.frame(Expression = as.numeric(gene_data),
                        Group = as.factor(sample_groups))
  
  # 그룹별 정규성 검정
  normality_pvals <- tapply(gene_df$Expression, gene_df$Group, function(x) {
    if (length(x) > 3) shapiro.test(x)$p.value else NA
  })
  
  # 전체 데이터를 통합한 정규성 검정
  overall_normality_pval <- if (length(gene_df$Expression) > 3) {
    shapiro.test(gene_df$Expression)$p.value
  } else {
    NA
  }
  
  # 등분산성 검정 (그룹이 2개 이상일 경우)
  if (length(unique(gene_df$Group)) > 1) {
    levene_pval <- leveneTest(Expression ~ Group, data = gene_df)$`Pr(>F)`[1]
  } else {
    levene_pval <- NA
  }
  
  # 결과 반환
  c(Gene = gene, Overall_Normality = overall_normality_pval, normality_pvals, Homogeneity_P = levene_pval)
}, mc.cores = detectCores())
names(results_parallel)=rownames(data_norm)
# 결과를 데이터프레임으로 변환
result_df_parallel <- do.call(rbind, lapply(results_parallel, as.data.frame.list))
result_df_parallel <- as.data.frame(result_df_parallel, stringsAsFactors = FALSE)

# 컬럼 이름 지정
group_count <- ncol(result_df_parallel) - 3  # Gene, Overall_Normality, Homogeneity_P 제외
colnames(result_df_parallel)[2]="overall normality"
colnames(result_df_parallel)[3:(2 + group_count)] <- paste0("Normality_P_Group", seq_len(group_count))
colnames(result_df_parallel)[1] <- "Gene"
colnames(result_df_parallel)[ncol(result_df_parallel)] <- "Homogeneity_P"

# 결과 저장
write.csv(result_df_parallel, "gene_test_results_parallel.csv", row.names = FALSE)

nrow(result_df_parallel[result_df_parallel$`overall normality`>0.05,])/nrow(result_df_parallel)
nrow(result_df_parallel[result_df_parallel$`Homogeneity_P`>0.05,])/nrow(result_df_parallel)
nrow(result_df_parallel[result_df_parallel$`overall normality`>0.05&result_df_parallel$`Homogeneity_P`>0.05,])/nrow(result_df_parallel)
```

### 결과, normality를 만족하는 gene이 너무 많아서...
<!-- > nrow(result_df_parallel[result_df_parallel$`overall normality`>0.05,]) -->
<!-- [1] 11344 -->
<!-- > nrow(result_df_parallel) -->
<!-- [1] 14293 -->

```{r}
# 1. Seurat Object 생성 (이미 normalized 된 값으로 가정)
sce <- CreateSeuratObject(counts = data_norm, project = "MyProject", min.cells = 3, min.features = 200)

# (만약 data_norm이 이미 normalized 된 expression matrix라면, 아래 NormalizeData 단계는 생략)
# sce <- NormalizeData(sce, normalization.method = "LogNormalize", scale.factor = 10000)

# 1.5 강제로 'data' layer를 만들어주기
## 예: 이미 저장된 normalized_matrix가 있다면
#sce <- SetAssayData(sce, slot = "data", new.data = normalized_matrix)
## 기본 Assay를 RNA로 설정한 후, counts를 data로 복사
DefaultAssay(sce) <- "RNA"
sce <- SetAssayData(sce, slot = "data", new.data = sce@assays$RNA@layers$counts)



# 2. Scaling (각 유전자별로 평균 0, 분산 1로 변환)
sce <- ScaleData(sce, features = rownames(sce))

# 3. PCA 실행
sce <- RunPCA(sce, features = rownames(sce), verbose = FALSE)

# 4. Neighbors와 Clustering 실행
sce <- FindNeighbors(sce, dims = 1:30, verbose = FALSE)
sce <- FindClusters(sce, resolution = 1.0, verbose = FALSE)

# 5. (옵션) UMAP 시각화
sce <- RunUMAP(sce, dims = 1:30, verbose = FALSE)
DimPlot(sce, reduction = "umap")
sce$response=SP$response
fm1=FindMarkers(sce,ident.1=0)
fm2=FindMarkers(sce,ident.1=0,test.use="t")
Idents(sce)="response"
fm3=FindMarkers(sce,ident.1=1)
fm4=FindMarkers(sce,ident.1=1,test.use="t")
fm5=FindMarkers(sce,ident.1=3)
fm6=FindMarkers(sce,ident.1=3,test.use="t")
```

### 진짜 normal일까? -> 매우 실망스러운 그래프였음
```{r}
gene_of_interest="SERPINA1"
# 특정 gene("MYGENE")의 expression 값을 데이터프레임으로 변환
gene_expr_df <- data.frame(Expression = as.numeric(data_norm[gene_of_interest, ]))

ggplot(gene_expr_df, aes(x = Expression)) +
  geom_histogram(binwidth = 50, fill = "lightblue", color = "black") +
  labs(title = "Histogram of MYGENE expression", x = "Expression", y = "Count") +
  theme_minimal()
```
#### qqplot
```{r}
# Q-Q plot (정규분포 비교)

gene_expr <- as.numeric(data_norm[gene_of_interest, ])
qqnorm(gene_expr, main = "Q-Q Plot of MYGENE Expression")
qqline(gene_expr, col = "red")

```
```{r}
library(ggplot2)

# 예시: 특정 유전자인 "MYGENE"의 표현값 추출 (data_norm은 행: gene, 열: 샘플)
gene_expr <- as.numeric(data_norm[gene_of_interest, ])
df <- data.frame(Expression = gene_expr)

# 관측값의 평균, 표준편차, 그리고 포아송의 lambda (평균 사용)
mean_expr <- mean(gene_expr)
sd_expr <- sd(gene_expr)
lambda_expr <- mean_expr

# 히스토그램과 커널 밀도 추정
p <- ggplot(df, aes(x = Expression)) +
  # density 스케일의 히스토그램
  geom_histogram(aes(y = ..density..), 
                 binwidth = diff(range(df$Expression)) / 30, 
                 fill = "lightgrey", 
                 color = "black", 
                 alpha = 0.6) +
  # 관측 데이터의 커널 밀도 curve
  geom_density(color = "blue", size = 1) +
  labs(title = "Distribution of MYGENE expression",
       x = "Expression",
       y = "Density") +
  theme_minimal()

# 정규분포 곡선 오버레이 (평균, 표준편차 이용)
p <- p + stat_function(fun = dnorm, 
                       args = list(mean = mean_expr, sd = sd_expr), 
                       color = "red", size = 1)

# 포아송 분포 오버레이  
# 포아송은 이산 분포이므로, 정수 범위 내 각 값에 대한 확률 질량함수(PMF)를 계산합니다.
x_int <- seq(floor(min(gene_expr)), ceiling(max(gene_expr)), by = 1)
poisson_density <- dpois(x_int, lambda = lambda_expr)
df_poisson <- data.frame(x = x_int, density = poisson_density)

# 포아송 결과를 점과 선으로 표시 (녹색)
p <- p + geom_point(data = df_poisson, aes(x = x, y = density), 
                    color = "darkgreen", size = 2) +
         geom_line(data = df_poisson, aes(x = x, y = density), 
                   color = "darkgreen", size = 1)

# 결과 출력
print(p)

```

# VHL의 분산과 response는 상관있는가?
```{r}
sce_analyze=sce
# sce_analyze=sce_list[["sce_ck"]]
sct_count_analyze=sce_analyze@assays$SCT@scale.data
#response가 숫자로 저장되어 있어야 합니다. 그렇지 않다면 변환 필요
# sce_analyze$response <- as.numeric(sce_analyze$response) #1, 2, 3에서는 유의성 없었음.
#sce_analyze$response <- as.numeric(sce_analyze$response_) #(1,2),3에서는 유의성이 더 떨어짐
sce_analyze$response <- as.numeric(sce_analyze$response__)#1,(2,3)에서는? 유의성이 있긴 한데,..... 역방향임.

# 1) VHL 발현량 추출 (행: VHL, 열: 모든 AOI)
# vhl_expr <- sct_count["VHL", ]  # 길이는 AOI 개수와 동일
vhl_expr <- sct_count_analyze["VHL", ]

# 2) 환자, VHL 발현량, response 정보를 하나의 데이터프레임으로 묶기
df <- data.frame(
  patient   = sce_analyze$patient,
  VHL_expr  = as.numeric(vhl_expr),  # 혹은 drop=TRUE 등으로 변환
  response  = sce_analyze$response
)

# 3-1) 환자별 AOI 수 계산: AOI>=3에서만 하고싶을 때
# df_aoi_count <- df %>%
#   group_by(patient) %>%
#   summarise(
#     aoi_count = n()
#   )
# 
# # AOI 수 기준 필터링 (예: AOI >= 3)
# patients_filtered <- df_aoi_count %>%
#   filter(aoi_count >= 3) %>%
#   pull(patient)
# df_filtered <- df %>%
#   filter(patient %in% patients_filtered)
# # 4) 환자별 VHL 분산 계산
# df_vhl_var <- df_filtered %>%
#   group_by(patient) %>%
#   summarise(
#     vhl_var = var(VHL_expr, na.rm = TRUE),
#     response = unique(response),
#     aoi_count = n()
#   )


# 3) 환자별 VHL 분산 계산
#    만약, 한 환자가 여러 AOI(열)에 걸쳐 있으면 환자별로 VHL_expr의 분산을 구함
df_vhl_var <- df %>%
  group_by(patient) %>%
  summarise(
    vhl_var  = var(VHL_expr, na.rm = TRUE),  # 분산
    # 환자별 response가 하나로 동일하다고 가정
    response = unique(response)
  )



# 1) Spearman 상관계수 계산
cor_result <- cor.test(df_vhl_var$vhl_var,
                       df_vhl_var$response,
                       method = "spearman")

# 2) 결과 확인
cor_result

df_vhl_var$response=as.factor(df_vhl_var$response)
ggplot(df_vhl_var, aes(x = factor(patient), y = vhl_var, fill = factor(response))) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  scale_fill_brewer(palette = "Set2") +
  geom_jitter(width = 0.2, alpha = 0.6, color = "black") +
  labs(
    title = "Response 그룹별 VHL 유전자 분산",
    x = "Response 그룹",
    y = "VHL 유전자 분산 (vhl_var)",
    fill = "Response 그룹"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "none"
  )


```


## p-val을 추가
```{r}
df_vhl_var$response <- factor(df_vhl_var$response, levels = c("0", "1"))
df_vhl_var$response=as.factor(df_vhl_var$response)
# 결측치 제거
df_vhl_var_clean <- df_vhl_var %>%
  filter(!is.na(response) & !is.na(vhl_var))

# 그룹별 데이터 개수 확인 (옵션)
df_vhl_var_clean %>%
  group_by(response) %>%
  summarise(count = n())

# Boxplot과 stat_compare_means 추가 (비교할 그룹을 하나로 설정)
ggplot(df_vhl_var_clean, aes(x = response, y = vhl_var, fill = response)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.6, color = "black") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Response 그룹별 VHL 유전자 분산",
    x = "Response 그룹",
    y = "VHL 유전자 분산 (vhl_var)",
    fill = "Response 그룹"
  ) +
  stat_compare_means(
    comparisons = list(c("0", "1")),  # 비교할 그룹을 하나로 설정 #3개라면 c("0","1"), c("0","2"),...
    method = "wilcox.test",            # 원하는 통계 검정 방법 선택 (예: wilcox.test)
    label = "p.signif"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "none"
  )
```


#VHL로 줄세워지는가?
```{r}

```


#MHC Class II molecule과 response의 상관관계는?
```{r}

sce_ck=subset(sce,subset=aoi=="CK+")

# HMC class II 모으기
## HLA-D로 시작하지만 HLA-D 자체는 제외한 유전자 선택
mhc_genes <- grep("^HLA-D(?!$)", rownames(sce), value = TRUE, perl = TRUE)
# mhc_genes <- grep("^HLA-D", rownames(sce_ck), value = TRUE)
# mhc_genes <- setdiff(mhc_genes, "HLA-D")


#발현량 추출
mhc_data <- FetchData(sce_ck, vars = mhc_genes)
mhc_data$patient <- sce_ck$patient
mhc_data$response=sce_ck$response


#정규성 가정 만족 시
for (gene in mhc_genes) {
  cat("ANOVA for", gene, ":\n")
  print(summary(aov(mhc_data[[gene]] ~ sce_ck$patient)))
}

for (gene in mhc_genes) {
  cat("ANOVA for", gene, ":\n")
  print(summary(aov(mhc_data[[gene]] ~ sce_ck$response)))
}

#정규성 가정 만족 X 시
for (gene in mhc_genes) {
  cat("Kruskal-Wallis Test for", gene, ":\n")
  print(kruskal.test(mhc_data[[gene]] ~ sce_ck$patient))
}


# 연속변수와의 상관성 ... patient가 연속은 아니다.
## pearson과 spearman
for (gene in mhc_genes) {
  cat("Pearson Correlation for", gene, ":\n")
  cor_test <- cor.test(mhc_data[[gene]], sce_ck$patient, method = "pearson")
  print(cor_test)
}

for (gene in mhc_genes) {
  cat("Spearman Correlation for", gene, ":\n")
  cor_test <- cor.test(mhc_data[[gene]], sce_ck$patient, method = "spearman")
  print(cor_test)
}

# PCA plot

# MHC-Class II 발현 데이터
mhc_re=mhc_data
mhc_re$response=as.numeric(mhc_re$response)
mhc_re=as.matrix(t(mhc_re))
for(col in 1:ncol(mhc_re)){
  mhc_re[,col]=as.numeric(mhc_re[,col])
  if(!is.numeric(mhc_re[,col])){
    print(paste0(col,"은 numeric이 아님."))
  }
}

all_numeric <- all(sapply(mhc_re, is.numeric))
if (!all_numeric) {
  stop("데이터가 numeric이 아닙니다. 확인 후 처리하세요.")
}


pca_data <- prcomp(mhc_re, scale. = TRUE)



# PCA 결과를 데이터프레임으로 변환
pca_df <- data.frame(
  PC1 = pca_data$x[, 1],
  PC2 = pca_data$x[, 2],
  Patient = sce_ck$patient
)

# PCA 플롯

ggplot(pca_df, aes(x = PC1, y = PC2, color = Patient)) +
  geom_point() +
  labs(title = "PCA of MHC-Class II Expression", x = "PC1", y = "PC2")



```

#250113. CK+에서 VHL이 높은 경우의 TME에서의 gene들은 어떤가
```{r}
# Step 1: Extract VHL expression and relevant genes
data <- FetchData(sce, vars = c("VHL", "CCN1", "CCN2", "SERPINE1", "VEGFA"))

# Step 2: Determine quartiles for VHL expression
quartiles <- quantile(data$VHL, probs = c(0.25, 0.5, 0.75))

# Step 3: Add a column to indicate quartile groups
data$quartile <- cut(
  data$VHL,
  breaks = c(-Inf, quartiles[1], quartiles[2], quartiles[3], Inf),
  labels = c("Q1", "Q2", "Q3", "Q4")
)

# Step 4: Subset data for Q1 and Q4
q1_data <- data[data$quartile == "Q1", ]
q4_data <- data[data$quartile == "Q4", ]

# Step 5: Calculate mean expression for each gene in Q1 and Q4
mean_expr <- data.frame(
  Gene = c("CCN1", "CCN2", "SERPINE1", "VEGFA"),
  Q1_Mean = colMeans(q1_data[, c("CCN1", "CCN2", "SERPINE1", "VEGFA")], na.rm = TRUE),
  Q4_Mean = colMeans(q4_data[, c("CCN1", "CCN2", "SERPINE1", "VEGFA")], na.rm = TRUE)
)

# Step 6: Statistical comparison (e.g., t-tests)
p_values <- sapply(c("CCN1", "CCN2", "SERPINE1", "VEGFA"), function(gene) {
  t.test(q1_data[[gene]], q4_data[[gene]])$p.value
})
mean_expr$p_value <- p_values


# visualization
plot_data <- melt(mean_expr, id.vars = "Gene", measure.vars = c("Q1_Mean", "Q4_Mean"))
colnames(plot_data) <- c("Gene", "Quartile", "Expression")

# Create a data frame for p-values to annotate on the plot
p_value_data <- mean_expr[, c("Gene", "p_value")]

# Step 8: Create a bar plot with p-value annotations
ggplot(plot_data, aes(x = Gene, y = Expression, fill = Quartile)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = round(Expression, 2)), 
            position = position_dodge(0.7), vjust = -0.5, size = 3.5) +
  geom_text(data = p_value_data, aes(x = Gene, y = max(mean_expr[, 2:3]), 
                                     label = paste0("p = ", signif(p_value, 3))), 
            inherit.aes = FALSE, vjust = -1, size = 4, color = "black") +
  ggtitle("Comparison of Gene Expression Between VHL Quartiles") +
  theme_minimal() +
  labs(x = "Gene", y = "Mean Expression") +
  scale_fill_manual(values = c("Q1_Mean" = "blue", "Q4_Mean" = "red"))
```

#CK+의 VHL과 동일 환자의 TME의 gene expression은?
```{r}
# Step 1: Extract metadata and VHL expression
metadata <- FetchData(sce, vars = c("patient", "ck", "tme"))
vhl_expression <- FetchData(sce, vars = "VHL")
gene_expression <- FetchData(sce, vars = c("CCN1", "CCN2", "SERPINE1", "VEGFA"))

# Step 2: Combine all relevant data into a single data frame
data <- cbind(metadata, VHL = vhl_expression$VHL, gene_expression)

# Step 3: Initialize an empty data frame to store results
results <- data.frame(
  patient = character(),
  avg_VHL = numeric(),
  avg_gene_expr = numeric(),
  stringsAsFactors = FALSE
)

# Step 4: Calculate averages per patient
patients <- unique(data$patient)

for (p in patients) {
  # Subset data for the current patient
  patient_data <- data[data$patient == p, ]
  
  # Get average VHL expression for cells with ck == TRUE
  avg_VHL <- mean(patient_data$VHL[patient_data$ck == TRUE], na.rm = TRUE)
  
  # Get average expression of selected genes for cells with tme == TRUE
  avg_genes <- rowMeans(patient_data[patient_data$tme == TRUE, c("CCN1", "CCN2", "SERPINE1", "VEGFA")], na.rm = TRUE)
  avg_genes1 <- patient_data[patient_data$tme == TRUE, c("CCN1")]
  avg_genes2 <- patient_data[patient_data$tme == TRUE, c("CCN2")]
  avg_genes3 <- patient_data[patient_data$tme == TRUE, c("SERPINE1")]
  avg_genes4 <- patient_data[patient_data$tme == TRUE, c("VEGFA")]
  
  # Store results
  results <- rbind(results, data.frame(
    patient = p,
    avg_VHL = avg_VHL,
    avg_gene_expr = avg_genes,
    avg_genes1,
    avg_genes2,
    avg_genes3,
    avg_genes4
  ))
}
# Step 5: Correlation Analysis
correlation <- cor(results$avg_VHL, results$avg_gene_expr, use = "complete.obs")
correlation1 <- cor(results$avg_VHL, results$avg_genes1, use = "complete.obs")
correlation2 <- cor(results$avg_VHL, results$avg_genes2, use = "complete.obs")
correlation3 <- cor(results$avg_VHL, results$avg_genes3, use = "complete.obs")
correlation4 <- cor(results$avg_VHL, results$avg_genes4, use = "complete.obs")

# Step 6: Visualization

ggplot(results, aes(x = avg_VHL, y = avg_gene_expr)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  ggtitle(paste("Association between VHL and Gene Expression (Correlation:", round(correlation, 2), ")")) +
  xlab("Average VHL Expression (ck == TRUE)") +
  ylab("Average Gene Expression (tme == TRUE)") +
  theme_minimal()

ggplot(results, aes(x = avg_VHL, y = avg_genes1)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  ggtitle(paste("Association between VHL and Gene Expression (Correlation:", round(correlation1, 2), ")")) +
  xlab("Average VHL Expression (ck == TRUE)") +
  ylab("Average Gene Expression (tme == TRUE)") +
  theme_minimal()

ggplot(results, aes(x = avg_VHL, y = avg_genes2)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  ggtitle(paste("Association between VHL and Gene Expression (Correlation:", round(correlation2, 2), ")")) +
  xlab("Average VHL Expression (ck == TRUE)") +
  ylab("Average Gene Expression (tme == TRUE)") +
  theme_minimal()

ggplot(results, aes(x = avg_VHL, y = avg_genes3)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  ggtitle(paste("Association between VHL and Gene Expression (Correlation:", round(correlation3, 2), ")")) +
  xlab("Average VHL Expression (ck == TRUE)") +
  ylab("Average Gene Expression (tme == TRUE)") +
  theme_minimal()

ggplot(results, aes(x = avg_VHL, y = avg_genes4)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  ggtitle(paste("Association between VHL and Gene Expression (Correlation:", round(correlation4, 2), ")")) +
  xlab("Average VHL Expression (ck == TRUE)") +
  ylab("Average Gene Expression (tme == TRUE)") +
  theme_minimal()

```

# 동일 ROI로 묶으면?
```{r}
# Step 1: Extract data and assign quartiles
data <- FetchData(sce, vars = c("VHL", "POSTN", "roi"))
quartiles <- quantile(data$VHL, probs = c(0.25, 0.5, 0.75))
data$aoi=rownames(data)

data$quartile <- cut(
  data$VHL,
  breaks = c(-Inf, quartiles[1], quartiles[2], quartiles[3], Inf),
  labels = c("Q1", "Q2", "Q3", "Q4")
)

# Step 2: Create a boxplot segregated by quartile
library(ggplot2)
ggplot(data, aes(x = quartile, y = POSTN, fill = quartile)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(aes(color = aoi), width = 0.2, alpha = 0.5) + # Show individual cells by ROI
  scale_fill_manual(values = c("Q1" = "blue", "Q2" = "green", "Q3" = "orange", "Q4" = "red")) +
  ggtitle("POSTN Expression by VHL Quartile") +
  labs(x = "VHL Quartile", y = "POSTN Expression") +
  theme_minimal() +
  guides(color = "none")  # Hide the legend for "aoi"

```
# linear
```{r}
# Step 1: Extract relevant data
data <- FetchData(sce, vars = c("VHL", "CCN1", "ck", "tme", "roi"))

# Step 2: Filter VHL for ck == TRUE and CCN1 for tme == TRUE
vhl_data <- data[data$ck == TRUE, c("aoi", "VHL")]
colnames(vhl_data) <- c("roi", "VHL")

ccn1_data <- data[data$tme == TRUE, c("roi", "CCN1")]
colnames(ccn1_data) <- c("roi", "CCN1")

# Step 3: Merge data by 'roi'
merged_data <- merge(vhl_data, ccn1_data, by = "roi")

# Fit a linear model
lm_model <- lm(VHL ~ CCN1, data = merged_data)

# Extract the slope coefficient and p-value
slope <- coef(lm_model)["CCN1"]
p_value <- summary(lm_model)$coefficients["CCN1", "Pr(>|t|)"]



library(ggplot2)

ggplot(merged_data, aes(x = CCN1, y = VHL, color = roi)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "black") +
  ggtitle("Association Between CCN1 and VHL Expression by ROI") +
  labs(x = "CCN1 Expression (tme == TRUE)", 
       y = "VHL Expression (ck == TRUE)", 
       color = "ROI") +
  annotate(
    "text", x = min(merged_data$CCN1), y = max(merged_data$VHL),
    label = paste0(
      "Slope = ", round(slope, 3), "\n",
      "p-value = ", signif(p_value, 3)
    ),
    hjust = 0, size = 4, color = "black"
  ) +
  theme_minimal() +
  theme(legend.position = "right")


```

# generalization of boxplot
```{r}
# Define the genes
vhl_gene <- "VHL"
target_gene <- "CCN1"
target_gene <- "POSTN"

# Step 1: Extract data and assign quartiles

data <- FetchData(sce, vars = c(vhl_gene, target_gene, "aoi"))
quartiles <- quantile(data[[vhl_gene]], probs = c(0.25, 0.5, 0.75))

data$quartile <- cut(
  data[[vhl_gene]],
  breaks = c(-Inf, quartiles[1], quartiles[2], quartiles[3], Inf),
  labels = c("Q1", "Q2", "Q3", "Q4")
)
library(ggplot2)

ggplot(data, aes_string(x = "quartile", y = target_gene, fill = "quartile")) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(aes_string(color = "aoi"), width = 0.2, alpha = 0.5) +
  scale_fill_manual(values = c("Q1" = "blue", "Q2" = "green", "Q3" = "orange", "Q4" = "red")) +
  ggtitle(paste(target_gene, "Expression by", vhl_gene, "Quartile")) +
  labs(x = paste(vhl_gene, "Quartile"), 
       y = paste(target_gene, "Expression"), 
       fill = "Quartile", 
       color = "ROI") +
  theme_minimal() +
  theme(legend.position = "right")

```


# generalization of linear
```{r}
# Define the genes
vhl_gene <- "VHL"
target_gene <- "HLA-DPA1" 

# Filter and merge data dynamically
data <- FetchData(sce, vars = c(vhl_gene, target_gene, "ck", "tme", "roi"))
vhl_data <- data[data$ck == TRUE, c("roi", vhl_gene)]
colnames(vhl_data) <- c("roi", "VHL")

target_data <- data[data$tme == TRUE, c("roi", target_gene)] #tme? or ck negative?
colnames(target_data) <- c("roi", "TargetGene")

# Merge the data
merged_data <- merge(vhl_data, target_data, by = "roi")

# Fit a linear model dynamically
lm_model <- lm(VHL ~ TargetGene, data = merged_data)

# Extract slope and p-value
slope <- coef(lm_model)["TargetGene"]
p_value <- summary(lm_model)$coefficients["TargetGene", "Pr(>|t|)"]

library(ggplot2)

ggplot(merged_data, aes_string(x = "TargetGene", y = "VHL", color = "roi")) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "black") +
  ggtitle(paste("Association Between", target_gene, "and", vhl_gene, "Expression by ROI")) +
  labs(x = paste(target_gene, "Expression (tme == TRUE)"),
       y = paste(vhl_gene, "Expression (ck == TRUE)"),
       color = "ROI") +
  annotate(
    "text", x = min(merged_data$TargetGene), y = max(merged_data$VHL),
    label = paste0(
      "Slope = ", round(slope, 3), "\n",
      "p-value = ", signif(p_value, 3)
    ),
    hjust = 0, size = 4, color = "black"
  ) +
  theme_minimal() +
  theme(legend.position = "right")


```

# 250114. corr
```{r}

# Specify the gene of interest
gene_of_interest <- "VHL"

# Check if the gene exists in the Seurat object
if (!(gene_of_interest %in% rownames(sce))) {
  stop(paste("Gene", gene_of_interest, "is not found in the Seurat object."))
}

# Extract the expression matrix
expression_matrix <- GetAssayData(sce_ckn, slot = "scale.data")  # Use the normalized expression data

# Get the expression vector for the gene of interest
gene_expression <- expression_matrix[gene_of_interest, ]

# Calculate correlations and p-values
cor_results <- apply(expression_matrix, 1, function(x) {
  cor_test <- cor.test(gene_expression, x, method = "pearson")
  c(correlation = cor_test$estimate, p_value = cor_test$p.value)
})

# Convert results into a data frame
cor_results_df <- as.data.frame(t(cor_results))
colnames(cor_results_df) <- c("correlation", "p_value")
cor_results_df$gene <- rownames(cor_results_df)

# Add a column for -log10(p-value)
cor_results_df$neg_log_p <- -log10(cor_results_df$p_value)

# Filter for visualization (optional, show significant correlations)
highlight_genes <- cor_results_df[cor_results_df$neg_log_p > 10, ]  # Adjust threshold as needed

# Create a scatter plot
ggplot(cor_results_df, aes(x = correlation, y = neg_log_p)) +
  geom_point(alpha = 0.6, color = "blue") +
  geom_text(data = highlight_genes, aes(label = gene), vjust = 1, hjust = 1, color = "red", size = 3) +
  labs(
    title = paste("Correlation of", gene_of_interest, "with Other Genes"),
    x = "Correlation Coefficient",
    y = "-log10(P-value)"
  ) +
  theme_minimal()

cor_results_df_ordered=cor_results_df[order(cor_results_df$correlation,decreasing = T),]
cor_results_df_ordered$rank=1:nrow(cor_results_df_ordered)
cor_results_df_ordered$rank_per=cor_results_df_ordered$rank/nrow(cor_results_df_ordered)

write.csv(cor_results_df_ordered, file="cor_results_df_ordered.csv")
# cor_all=cor_results_df_ordered
# cor_ckp=cor_results_df_ordered
# cor_tme=cor_results_df_ordered
cor_ckn=cor_results_df_ordered
```
## mutiple genes
```{r}
# Specify the genes of interest
mhc_2_genes=cor_all$gene[which(grepl("HLA-D", cor_all$gene))]
genes_of_interest=mhc_2_genes
#genes_of_interest <- c("VHL", "TP53", "EGFR")  # Replace with your genes of interest

# Check if all genes exist in the Seurat object
missing_genes <- genes_of_interest[!(genes_of_interest %in% rownames(sce))]
if (length(missing_genes) > 0) {
  stop(paste("The following genes are not found in the Seurat object:", paste(missing_genes, collapse = ", ")))
}


# Extract the expression matrix as a numeric matrix
expression_matrix <- as.matrix(GetAssayData(sce, slot = "scale.data"))  # Ensure it's numeric # Use normalized expression data

# Subset the expression matrix for the genes of interest
expression_subset <- expression_matrix[genes_of_interest, ]

# Confirm both matrices are numeric
if (!is.numeric(expression_subset) || !is.numeric(expression_matrix)) {
  stop("Expression data must be numeric. Check the input matrices.")
}

# Calculate correlations
correlation_matrix <- cor(t(expression_subset), t(expression_matrix), method = "pearson")  # Correlate genes of interest with all genes


# Convert to a data frame for further analysis (optional)
correlation_df <- as.data.frame(correlation_matrix)

# # For heatmap, take absolute correlation (optional, for better visualization)
# heatmap_data <- abs(correlation_matrix)
# 
# # Generate the heatmap
# pheatmap(
#   heatmap_data,
#   cluster_rows = TRUE,         # Cluster genes of interest
#   cluster_cols = TRUE,         # Cluster all genes
#   show_rownames = TRUE,        # Show gene names of interest
#   show_colnames = FALSE,       # Hide names of all genes
#   main = "Correlation Heatmap",
#   color = colorRampPalette(c("blue", "white", "red"))(50)  # Blue for low, red for high correlation
# )
```

### filter
```{r}
# Specify the genes of interest
genes_of_interest <- c("VHL", "TP53", "EGFR")  # Replace with your genes of interest

# Define p-value threshold
p_value_threshold <- 0.0001  # Set your significance threshold

# Extract the expression matrix as a numeric matrix
expression_matrix <- as.matrix(GetAssayData(sce, slot = "scale.data"))  # Ensure it's numeric

# Subset the expression matrix for the genes of interest
expression_subset <- expression_matrix[genes_of_interest, ]

# Initialize a list to store filtered results
filtered_results <- list()

# Loop through each gene of interest and calculate correlations and p-values
for (gene in genes_of_interest) {
  # Get the expression vector for the current gene
  gene_expression <- expression_subset[gene, ]
  
  # Apply correlation and calculate p-values for all genes
  cor_results <- apply(expression_matrix, 1, function(x) {
    cor_test <- cor.test(gene_expression, x, method = "pearson")
    c(correlation = cor_test$estimate, p_value = cor_test$p.value)
  })
  
  # Convert results into a data frame
  cor_results_df <- as.data.frame(t(cor_results))
  colnames(cor_results_df) <- c("correlation", "p_value")
  cor_results_df$gene <- rownames(cor_results_df)
  
  # Add -log10(p-value) for visualization
  cor_results_df$neg_log_p <- -log10(cor_results_df$p_value)
  
  # Filter genes based on the p-value threshold
  filtered_genes <- cor_results_df[cor_results_df$p_value < p_value_threshold, ]
  
  # Add filtered results to the list
  filtered_results[[gene]] <- filtered_genes
}

# Combine filtered results for all genes of interest
combined_results <- do.call(rbind, lapply(filtered_results, function(df) {
  df$target_gene <- rownames(df)
  return(df)
}))

# Generate a heatmap or scatter plot (optional)
library(ggplot2)

ggplot(combined_results, aes(x = correlation, y = neg_log_p)) +
  geom_point(alpha = 0.6, color = "blue") +
  geom_text(aes(label = gene), data = combined_results[combined_results$neg_log_p > -log10(p_value_threshold * 10), ], hjust = 1.5, vjust = 1.5, size = 3, color = "red") +
  labs(
    title = "Correlation Analysis for Selected Genes",
    x = "Correlation Coefficient",
    y = "-log10(P-value)"
  ) +
  theme_minimal()
```
### heatmap
```{r}
# Filter expression matrix for significant genes
significant_genes <- unique(combined_results$gene)
filtered_matrix <- expression_matrix[significant_genes, ]

# Generate heatmap
library(pheatmap)
pheatmap(
  abs(filtered_matrix),  # Use absolute correlation values for better visualization
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = "Filtered Correlation Heatmap",
  color = colorRampPalette(c("blue", "white", "red"))(50)
)
```
## multiple genes, p-value side by side
```{r}
# Specify the genes of interest
mhc_2_genes=cor_all$gene[which(grepl("HLA", cor_all$gene))]
genes_of_interest=mhc_2_genes
# genes_of_interest <- c("VHL", "TP53", "EGFR")  # Replace with your genes of interest

# Check if all genes exist in the Seurat object
missing_genes <- genes_of_interest[!(genes_of_interest %in% rownames(sce))]
if (length(missing_genes) > 0) {
  stop(paste("The following genes are not found in the Seurat object:", paste(missing_genes, collapse = ", ")))
}

# Extract the expression matrix as a numeric matrix
expression_matrix <- as.matrix(GetAssayData(sce_tme, slot = "scale.data"))  # Ensure it's numeric

# Subset the expression matrix for the genes of interest
expression_subset <- expression_matrix[genes_of_interest, ]

# Confirm both matrices are numeric
if (!is.numeric(expression_subset) || !is.numeric(expression_matrix)) {
  stop("Expression data must be numeric. Check the input matrices.")
}

# Initialize matrices for correlations and p-values
correlation_matrix <- matrix(NA, nrow = length(genes_of_interest), ncol = nrow(expression_matrix))
p_value_matrix <- matrix(NA, nrow = length(genes_of_interest), ncol = nrow(expression_matrix))

rownames(correlation_matrix) <- genes_of_interest
colnames(correlation_matrix) <- rownames(expression_matrix)
rownames(p_value_matrix) <- genes_of_interest
colnames(p_value_matrix) <- rownames(expression_matrix)

# Calculate correlations and p-values
for (i in seq_along(genes_of_interest)) {
  gene <- genes_of_interest[i]
  for (j in seq_len(nrow(expression_matrix))) {
    other_gene <- rownames(expression_matrix)[j]
    test_result <- cor.test(expression_subset[gene, ], expression_matrix[other_gene, ], method = "pearson")
    correlation_matrix[i, j] <- test_result$estimate
    p_value_matrix[i, j] <- test_result$p.value
  }
}

# Combine correlation coefficients and p-values into a data frame for better readability
results <- list()
for (i in seq_along(genes_of_interest)) {
  results[[genes_of_interest[i]]] <- data.frame(
    Gene = rownames(expression_matrix),
    Correlation = correlation_matrix[i, ],
    P_Value = p_value_matrix[i, ]
  )
}

# Example: View results for the first gene of interest
head(results[[genes_of_interest[1]]])
# Combine results for all genes of interest into a single data frame
merged_results <- data.frame(Gene = rownames(expression_matrix))

for (gene in genes_of_interest) {
  # Add correlation and p-value columns for each gene of interest
  merged_results[[paste0(gene, "_Correlation")]] <- correlation_matrix[gene, ]
  merged_results[[paste0(gene, "_P_Value")]] <- p_value_matrix[gene, ]
}

# View the combined results
head(merged_results)
write.csv(merged_results,file="merged_result_HLA.csv")
```

# boxplots - 250131
```{r}
genes_of_interest=c("CD274", "CCL5", "TRIM21", "CXCL10", "CD8A", "CD8B", "SLAMF7", "CXCL13", "GCH1", "TBX21", "IRF1", "CCL4", 
"LCK", "TAGAP", "CD244", "HLA-DQA1", "P2RY6", "STAT1", "APOL1", "LAG3", "HLA-DPA1", "GBP4", "IDO1", "GBP5", "HLA-F", 
"HLA-DMA", "TRIM69", "TAPBP", "PDCD1")

# Positively regulated genes
postn_pos <- c("SERPINE1", "CTGF", "IGFBP3", "IL11", "MMP1", "MMP3", "MMP13", "IL6", "IL8", "NOS2", "ADAMTS5", "VEGFB", "MMP2", "MMP9", "PDGFA", "PDGFB")

# Negatively regulated genes
postn_neg <- c("SMAD7", "MMP1")

boxplot_list=list()
# for(gene in genes_of_interest){
#   try({boxplot_list[[gene]]=mybox(sce,features=gene,quantile_gene = "POSTN_pos",quantile_number = 4)})
# }

for(gene in genes_of_interest){
  try({boxplot_list[[gene]]=mybox(sce_ck,features=gene,quantile_gene = "HIF_pos",quantile_number = 2)})
}

```

# Figures

## 1. AOI no.

### Bar plot
#### 누적 = position=stack
```{r}
# Create the data frame
data <- data.frame(
  AOI = rep(c("Cancer cell", "Cancer Associated Fibroblast", "TME"), each = 2),
  Response = rep(c("Non-Responder", "Responder"), times = 3),
  Count = c(21, 18, 7, 6, 13, 18)
)

# Create the cumulative bar graph
ggplot(data, aes(x = AOI, y = Count, fill = Response)) +
  geom_bar(stat = "identity", position = "stack") +  # Stacked bar chart
  scale_fill_manual(values = c("gray", "blue")) +  # Custom colors
  labs(title = "Cumulative Bar Graph of Response by AOI",
       x = "AOI",
       y = "Count",
       fill = "Response Type") +
  theme_minimal()
```
#### 양옆에 세우기 - dodge
```{r}
# Create the data frame
data <- data.frame(
  AOI = rep(c("Cancer cell", "Fibroblast", "TME"), each = 2),
  Response = rep(c("Non-Responder", "Responder"), times = 3),
  Count = c(21, 18, 7, 6, 13, 18)
)

# Ensure the AOI categories appear in the desired order
data$AOI <- factor(data$AOI, levels = c("Cancer cell", "Fibroblast", "TME"))

# Create the cumulative bar graph
ggplot(data, aes(x = AOI, y = Count, fill = Response)) +
  geom_bar(stat = "identity", position = "dodge",width=0.6) +  # Stacked bar chart
  scale_fill_manual(values = c("gray", "blue")) +  # Custom colors
  labs(title = "          Bar Graph of Response by AOI",
       x = "Area of Interest",
       y = "AOI Count",
       fill = "ICI Response") +
  theme_minimal()+
    theme(
    text = element_text(size = 14),          # General text size
    legend.text = element_text(size = 10),    # Adjust only legend text size
    axis.text.x = element_text(size = 14, face = "bold")
  )
```

### Table
```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(gt)

# Create the data frame
data <- data.frame(
  AOI = c("Cancer cell", "Cancer Associated Fibroblast", "TME"),
  `Non_Responder` = c(21, 7, 13),
  `Responder` = c(18, 6, 18)
)

# Create an aesthetic table using gt
data %>%
  gt() %>%
  tab_header(
    title = "Response Count by AOI Category",
    subtitle = "Comparison of Responder and Non-Responder Counts"
  ) %>%
  cols_label(
    AOI = "AOI Category",
    `Non_Responder` = "Non-Responder Count",
    `Responder` = "Responder Count"
  ) %>%
  data_color(
    columns = c(`Non_Responder`, `Responder`),
    colors = scales::col_numeric(
      palette = c("#D3D3D3", "#4682B4"),
      domain = NULL
    )
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#F5F5F5"),
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = everything()
    )
  ) %>%
  tab_options(
    table.font.size = px(14),
    heading.align = "center"
  )

```
## 2. Target cell profiling
```{r}
sce$AOI_r=case_when(
  sce$AOI%in%c("TME","SMA+") & sce$response_ ~ "TME \n Response",
  sce$AOI%in%c("TME","SMA+") & !sce$response_ ~ "TME \n NonResponse",
  sce$AOI=="CK+" & sce$response_ ~ "Cancer cell \n Response",
  sce$AOI=="CK+" & !sce$response_ ~ "Cancer cell \n NonResponse",
  TRUE ~ "nothing"
)
myhm_genesets2(sce,gene_sets = G_rcc[c(2:7,9:15)],group="AOI_r")

```

## 3. Volcanoplots - Responder vs Nonresponder - in CK+, SMA+, TME
```{r}
fmckr_=fmckr3
fmckr_$p_val_adj=fmckr_$p_val
which(fmckr_$gene=="CCN3")#이름 긴 gene 위치 알아내기
fmckr__=fmckr_[-27,] #POTEB2,POTEC,POTEB,LOC102723502,POTED,LOC100288966,POTEB3 제거... 이게 의미가 있는 gene이라서..
rownames(fmckr_)[27]="POTEB2"
myv(fmckr_,x_limit=2.2, y_limit = 5,log2fc_cutoff = 1,plot_title = "Differentially Expressed Genes in Cancer cell:\nResponder vs Nonresponder")

fmckr_=fmtmer3
fmckr_$p_val_adj=fmckr_$p_val
# which(fmckr_$gene=="CCN3")#이름 긴 gene 위치 알아내기
# fmckr__=fmckr_[-27,] #POTEB2,POTEC,POTEB,LOC102723502,POTED,LOC100288966,POTEB3 제거... 이게 의미가 있는 gene이라서..
# rownames(fmckr_)[27]="POTEB2"
myv(fmckr_,x_limit=1.8, y_limit = 3.6,log2fc_cutoff = 0.5,plot_title = "Differentially Expressed Genes in TME:\nResponder vs Nonresponder")

fmckr_=fmsmar3
fmckr_$p_val_adj=fmckr_$p_val
# which(fmckr_$gene=="CCN3")#이름 긴 gene 위치 알아내기
# fmckr__=fmckr_[-27,] #POTEB2,POTEC,POTEB,LOC102723502,POTED,LOC100288966,POTEB3 제거... 이게 의미가 있는 gene이라서..
# rownames(fmckr_)[27]="POTEB2"
myv(fmckr_,x_limit=2.2, y_limit = 3,log2fc_cutoff = 0.5,plot_title = "Differentially Expressed Genes in CAF:\nResponder vs Nonresponder")
```

## 4-1.
```{r}
sce_tme$VHL=case_when(
  sce_tme$vhl=="3" ~ "Strong",
  sce_tme$vhl=="2" ~ "Intermediate",
  sce_tme$vhl=="1" ~ "Weak"
)
sce_tme$VHL=factor(sce_tme$VHL,levels=c("Weak","Intermediate","Strong"))
#data$AOI <- factor(data$AOI, levels = c("Cancer cell", "Fibroblast", "TME"))

myhm_genesets2(sce_tme,group="VHL",gene_sets=G_rcc[c(6:8,10,11,13,14,16,17)],title = "TME Signature",x_label="VHL Expression - IHC")
```

## 4-2. Volcanoplot
```{r}
fmckhif_p_fc_p=fmckhif[fmckhif$p_val<0.05,][fmckhif$avg_log2FC>1,]
fmckhif_p_fc_n=fmckhif[fmckhif$p_val<0.05,][fmckhif$avg_log2FC< -1,]
fmckr3n_p=fmckr3n[fmckr3n$p_val<0.05,]
fmckr3p_p=fmckr3p[fmckr3p$p_val<0.05,]

hif_favor_NR=intersect(fmckr3n_p$gene,fmckhif_p_fc_p$gene) #
hif_favor_R=intersect(fmckr3p_p$gene,fmckhif_p_fc_p$gene)
hif_unfavor_NR=intersect(fmckr3n_p$gene,fmckhif_p_fc_n$gene) #
hif_unfavor_R=intersect(fmckr3p_p$gene,fmckhif_p_fc_n$gene)

length(hif_favor_R)
length(hif_favor_NR)
length(hif_unfavor_R)
length(hif_unfavor_NR)

paste(hif_favor_R,collapse = ", ")
paste(hif_favor_NR,collapse = ", ")
paste(hif_unfavor_R,collapse = ", ")
paste(hif_unfavor_NR,collapse = ", ")
```

## 5. near_CAF vs core
### 5-1. 
```{r}

```

### 5-2.
```{r}
fm_tumorsite_=fm_tumorsite
fm_tumorsite_$p_val_adj=fm_tumorsite_$p_val
myv(fm_tumorsite_,x_limit=1.5, y_limit = 3,log2fc_cutoff = 0.5,plot_title = "Differentially Expressed Genes:\nCAF-proximal cancer cell vs CAF-distant cancer cell")
paste(fm_tumorsite[fm_tumorsite$avg_log2FC>0.5,][fm_tumorsite$p_val<0.05,]$gene[1:100],collapse=", ")
paste(fm_tumorsite[fm_tumorsite$avg_log2FC>0.5,][fm_tumorsite$p_val<0.05,]$gene,collapse=", ")
```

```{r}
gsea_caf=my_gsea(fm_tumorsite)
```

# SpatialDecon

There are quite a few readouts here. Let's review the important ones:

* beta: the cell abundance scores of the rolled-up/major cell types
* beta.granular: the cell abundance scores of the granular cell types, 
corresponding to the columns of the cell profile matrix
* yhat, resids: the fitted values and log2-scale residuals from the 
deconvolution fit. Can be used to measure each observation's goodness-of-fit, a 
possible QC metric. 
* cell.counts, cell.counts.granular: estimated numbers of each cell type, 
derived using the nuclei count input
* prop_of_nontumor: the beta matrix rescaled to give the proportions of 
non-tumor cells in each observation. 
* X: the cell profile matrix used, including newly-derived tumor-specific 
columns.
```{r}
rownames(data_filtered_aoi)=data_filtered_aoi$ProbeDisplayName
# norm = mini_geomx_dataset$normalized
norm=data_filtered_aoi[4:ncol(data_filtered_aoi)]
rownames(norm)=data_filtered_aoi$ProbeDisplayName

# Select rows where rownames start with "NegProbe"
neg_rows <- grep("^NegProbe", rownames(norm))

# If you also want to include rows based on a HUGOSymbol value (for example, those equal to "NegProbe")
# and you have feature annotations in a data frame (e.g., fData(norm)$HUGOSymbol), you might do:
# neg_rows <- which(fData(norm)$HUGOSymbol == "NegProbe")

# Add or overwrite the row named "negprobe" with these averages
norm["NegProbe", ] <- colMeans(norm[neg_rows, , drop = FALSE])


per.observation.mean.neg = norm["NegProbe", ]
norm=matrix(norm)

bg = sweep(norm * 0, 2, 1, "+")
# Error in Ops.data.frame(x, aperm(array(STATS, dims[perm]), order(perm)),  : 
  # list of length 1186319 not meaningful
# bg2 = derive_GeoMx_background(norm = norm,
#                              probepool = rep(1, nrow(norm)),
#                              negnames = "NegProbe")

res = spatialdecon(norm = norm,
                   bg = bg,
                   X = safeTME,
                   align_genes = TRUE)
heatmap(res$beta, cexCol = 0.5, cexRow = 0.7, margins = c(10,7))
heatmap(res$beta, cexCol = 0.5, cexRow = 0.7)

restils = spatialdecon(norm = norm,                     # normalized data
                       raw = raw,                       # raw data, used to down-weight low-count observations 
                       bg = bg,                         # expected background counts for every data point in norm
                       X = safeTME,                     # safeTME matrix, used by default
                       cellmerges = safeTME.matches,   # safeTME.matches object, used by default
                       cell_counts = annot$nuclei,      # nuclei counts, used to estimate total cells
                       is_pure_tumor = annot$istumor,   # identities of the Tumor segments/observations
                       n_tumor_clusters = 5)            # how many distinct tumor profiles to append to safeTME

str(restils)

heatmap(sweep(restils$X, 1, apply(restils$X, 1, max), "/"),
         labRow = NA, margins = c(10, 5))
```




# genes
```{r}


hif1a_targets <- c(
  # Angiogenesis
  "VEGFA", "FLT1", "KDR", "ANGPTL4", "PDGFB", "ADM",
  
  # Glucose Metabolism
  "GLUT1", "HK1", "HK2", "PFKFB3", "PFKFB4", "LDHA", "PGK1", "ENO1", "PDPK1",
  
  # Lactate and pH Regulation
  "MCT4", "CAR9",
  
  # Cell Proliferation and Survival
  "EPO", "BNIP3", "BNIP3L", "IGF2", "TGFA",
  
  # Iron Metabolism
  "TFRC", "HMOX1", "FTH1",
  
  # ECM Remodeling
  "LOX", "COL5A1", "COL6A3", "MMP2", "MMP9",
  
  # Apoptosis and Stress Response
  "PMAIP1", "DDIT4", "HSP90AA1", "ATF4",
  
  # Oxidative Stress Response
  "SOD2", "PRDX2", "TXN",
  
  # Other Genes
  "CXCR4", "PLIN2", "CYGB", "SERPINE1", "EDN1"
)
```
## the review article markers
```{r}

rcc_review=list(
  emt_markers = c(
  "CDH1", "CLDN4", "OCLN", "KRT18", "KRT19",  # Epithelial markers
  "VIM", "FN1", "SNAI1", "SNAI2", "TWIST1", "TWIST2", "ZEB1", "ZEB2",  # Mesenchymal markers
  "COL1A1", "COL1A2", "TGFB1", "MMP2", "MMP9", "SERPINE1"  # EMT regulators
)
,
macrophage_fibroblast_markers = c(
  "IL1B", "CD68", "CD163", "CSF1R",  # Macrophage markers
  "ACTA2", "PDPN", "COL3A1", "COL6A3", "FAP",  # Fibroblast markers
  "IL1R1", "CSF1"  # Receptor-ligand pairs
)
,
hyaline_stroma_markers = c(
  "CP", "COL4A1", "COL4A2",  # Ceruloplasmin and collagen IV
  "TNC", "SPARC", "DCN"  # Stromal markers
)
,
tls_markers = c(
  "MS4A1", "CD79A", "CD79B", "IGHG", "IGHM", "IGLC",  # B cell markers
  "CD3E", "CD4", "CD8A", "CXCL13",  # T cell markers
  "FAP", "CXCL12",  # Fibroblast markers in TLS
  "C3", "C4B", "C5"  # Complement pathway genes
)

)
```

##
```{r}
HIF_pos=c("HIF1A","SLEC2A1","ENO1","BHLHB2","BNIP3","PDK1","MIF","LDHA","GAPDH","VEGFA","SERPINE1","ANKRD37","DDIT4","STC2")
HIF_neg=c("ISG15","NRF1","HLA-A","HLA-B","HLA-C","HLA-E","HLA-F","HLA-G","HLA-K","HLA-L") # K, L - pseudogenes, E~G: less polymorphic
postn_pos <- c("SERPINE1", "CTGF", "IGFBP3", "IL11", "MMP1", "MMP3", "MMP13", "IL6", "IL8", "NOS2", "ADAMTS5", "VEGFB", "MMP2", "MMP9", "PDGFA", "PDGFB")
mhc1_genes <- grep("^HLA-(?!D)", rownames(sce), value = TRUE, perl = TRUE)
mhc2_genes <- grep("^HLA-D(?!$)", rownames(sce), value = TRUE, perl = TRUE)

# Additional positively correlated genes with HIF-2α
HIF2_pos_genes <- c("EPO", "VEGFA", "CCND1", "ANGPT2", "DLL4", "PPARA", "POSTN", "SERPINE1", "EGLN3")


```