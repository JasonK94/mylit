% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/pseudobulk_deg.R
\name{pseudobulk_deg}
\alias{pseudobulk_deg}
\title{Perform Pseudobulk Differential Gene Expression Analysis}
\usage{
pseudobulk_deg(
  sobj,
  sample_col,
  compare_col,
  bulk_col,
  idents.1 = NULL,
  idents.2 = NULL,
  test.use = "wilcox",
  assay = NULL,
  slot = "counts",
  min.cells.gene = 3,
  min.pct = 0.1,
  logfc.threshold = 0.25,
  min.samples.group = 2,
  edgeR.filterByExpr.min.count = 5,
  edgeR.filterByExpr.min.total.count = 10,
  DESeq2.useT = FALSE,
  DESeq2.fitType = "parametric",
  BPPARAM = BiocParallel::SerialParam(),
  ...
)
}
\arguments{
\item{sobj}{A Seurat object.}

\item{sample_col}{Character string. The name of the metadata column identifying individual samples or patients.}

\item{compare_col}{Character string. The name of the metadata column used for grouping samples for DEG comparison (e.g., prognosis factor, treatment group).}

\item{bulk_col}{Character string. The name of the metadata column that defines the categories within which pseudobulking and DEG analysis will be performed (e.g., cell type). DEGs are found for each unique value in this column separately.}

\item{idents.1}{Character vector or NULL. Specifies the identity (or identities) in \code{compare_col} for the first group.
If NULL (default), performs a "FindAllMarkers" style analysis, comparing each identity in \code{compare_col} against all others within each \code{bulk_col} category.}

\item{idents.2}{Character vector or NULL. Specifies the identity (or identities) in \code{compare_col} for the second group.
If NULL (default) and \code{idents.1} is specified, \code{idents.1} is compared against all other identities.
If \code{idents.1} is also NULL, this parameter is ignored.}

\item{test.use}{Character string. The statistical test to use. Options are:
"edgeR", "DESeq2", "wilcox" (default), "t.test", "roc".}

\item{assay}{Character string or NULL. The Seurat assay to use for fetching counts. If NULL, defaults to \code{DefaultAssay(sobj)}.}

\item{slot}{Character string. The slot from which to pull data for aggregation (e.g., "counts"). Defaults to "counts".}

\item{min.cells.gene}{Numeric. For 'wilcox', 't.test', 'roc': minimum number of pseudobulk samples where a gene must be detected to be included in the analysis. This is applied per comparison (i.e., gene must be in \code{min.cells.gene} samples in group1 OR group2). Seurat's \code{FindMarkers} uses this for single cells.}

\item{min.pct}{Numeric. For 'wilcox', 't.test', 'roc': only test genes that are detected in at least this fraction of pseudobulk samples in either of the two groups.}

\item{logfc.threshold}{Numeric. For 'wilcox', 't.test', 'roc': limit testing to genes which show at least this an absolute (log2) fold change between the two groups of pseudobulk samples. For 'roc', this is applied to the AUC value.}

\item{min.samples.group}{Numeric. Minimum number of pseudobulk samples required in each group for a comparison to proceed. Defaults to 2.}

\item{edgeR.filterByExpr.min.count}{Numeric. Passed to \code{min.count} in \code{edgeR::filterByExpr}. Default is 5.}

\item{edgeR.filterByExpr.min.total.count}{Numeric. Passed to \code{min.total.count} in \code{edgeR::filterByExpr}. Default is 10.}

\item{DESeq2.useT}{Logical. For DESeq2, passed to \code{useT} in \code{DESeq} function if initial fit fails. Defaults to FALSE.}

\item{DESeq2.fitType}{Character. For DESeq2, passed to \code{fitType} in \code{DESeq} function. Default is "parametric". If error, "local" may be tried.}

\item{BPPARAM}{BiocParallel::BiocParallelParam instance, for parallel execution in DESeq2. Default is \code{BiocParallel::SerialParam()}.}

\item{...}{Additional arguments passed to the underlying statistical test functions (e.g., \code{exact} for \code{wilcox.test}).}
}
\value{
A data frame with DEG results, similar to Seurat's \code{FindMarkers} output. Columns include:
\code{gene}, \code{cluster} (the \code{idents.1} group or current group in \code{FindAllMarkers} mode),
\code{bulk_category} (from \code{bulk_col}), \code{avg_log2FC}, \code{p_val}, \code{p_val_adj}, \code{pct.1}, \code{pct.2}.
For \code{test.use = "roc"}, \code{avg_log2FC} column contains the AUC.
}
\description{
This function takes a Seurat object, aggregates counts to create pseudobulks
based on specified sample and bulk category keys, and then performs DEG analysis
between groups defined by a comparison key. It supports edgeR, DESeq2,
Wilcoxon rank-sum test, Student's t-test, and ROC analysis.
}
\examples{
\dontrun{
# Assuming 'pbmc_small' is a Seurat object with relevant metadata
# pbmc_small$sample <- rep(paste0("sample", 1:2), length.out = ncol(pbmc_small))
# pbmc_small$cell_type <- pbmc_small$RNA_snn_res.0.8
# pbmc_small$condition <- rep(c("A", "B"), length.out = ncol(pbmc_small))
# Ensure 'condition' is consistent per 'sample'
# sample_conditions <- pbmc_small@meta.data \%>\% distinct(sample, condition)
# pbmc_small <- pbmc_small[, !(pbmc_small$sample \%in\% names(which(table(sample_conditions$sample) > 1)))]
# temp_meta <- pbmc_small@meta.data
# temp_meta <- temp_meta \%>\% group_by(sample) \%>\% mutate(condition = first(condition)) \%>\% ungroup()
# rownames(temp_meta) <- colnames(pbmc_small)
# pbmc_small@meta.data <- temp_meta

# deg_results_wilcox <- pseudobulk_deg(
#   sobj = pbmc_small,
#   sample_col = "sample",
#   compare_col = "condition", # e.g. Control vs Treatment
#   bulk_col = "cell_type",    # e.g. B cells, T cells
#   test.use = "wilcox"
# )

# To use edgeR or DESeq2, ensure they are installed
# if (requireNamespace("edgeR", quietly = TRUE)) {
#   deg_results_edgeR <- pseudobulk_deg(
#     sobj = pbmc_small,
#     sample_col = "sample",
#     compare_col = "condition",
#     bulk_col = "cell_type",
#     test.use = "edgeR"
#  )
# }
# if (requireNamespace("DESeq2", quietly = TRUE) &&
#     requireNamespace("BiocParallel", quietly = TRUE)) {
#   deg_results_DESeq2 <- pseudobulk_deg(
#     sobj = pbmc_small,
#     sample_col = "sample",
#     compare_col = "condition",
#     bulk_col = "cell_type",
#     test.use = "DESeq2"
#   )
# }
}
}
