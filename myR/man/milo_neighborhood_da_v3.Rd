% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/test_gpt.R
\name{milo_neighborhood_da_v3}
\alias{milo_neighborhood_da_v3}
\title{MILO neighborhood DA (self-contained v3)}
\usage{
milo_neighborhood_da_v3(
  sobj,
  target_var = "g3",
  batch_var = "GEM",
  patient_var = "hos_no",
  cluster_var = "anno3.scvi",
  reduced_dim = "PCA",
  k = 30,
  d = 50,
  prop = 0.1,
  fixed_effects = NULL,
  random_effects = NULL,
  glmm_family = c("nb", "poisson"),
  p_adj_method = "BH",
  fdr_thresh = 0.1,
  logfc_thresh = 0.5,
  seed = 1,
  use_future = FALSE,
  workers = max(1, parallel::detectCores() - 1)
)
}
\arguments{
\item{sobj}{Seurat object (uses RNA assay by default).}

\item{target_var}{Character: group variable to compare (e.g., "g3").}

\item{batch_var}{Character: batch factor (e.g., "GEM").}

\item{patient_var}{Character: pseudobulk unit / sample ID (e.g., "hos_no").}

\item{cluster_var}{Character: cluster labels (e.g., "anno3.scvi").}

\item{reduced_dim}{"PCA","UMAP","TSNE" (graph built on PCA internally).}

\item{k, d, prop}{Milo graph/neighborhood params (defaults: 30,50,0.1).}

\item{fixed_effects}{Character vector; defaults to c(target_var, batch_var).}

\item{random_effects}{Character vector; if length>0, GLMM mode is used.}

\item{glmm_family}{"nb" (default) or "poisson".}

\item{p_adj_method}{P-value adjustment method (default "BH").}

\item{fdr_thresh, logfc_thresh}{Thresholds for significance flags.}

\item{seed}{RNG seed.}

\item{use_future}{Logical; if TRUE and GLMM mode, use future.apply for parallel fits.}

\item{workers}{Integer workers for future (only if use_future=TRUE).}
}
\value{
list(mode, milo, da_nhood_with_cluster, da_by_cluster, formula(optional))
}
\description{
Neighborhood-level differential abundance with two modes:
(A) edgeR GLM + spatial FDR (fixed effects only),
(B) GLMM via glmmTMB with random effects (adj.p used; no spatial FDR).
Internally replaces countCells() by a fast sparse-matrix method.
}
\examples{
out <- milo_neighborhood_da_v3(
  sobj = data_seurat,
  target_var="g3", batch_var="GEM", patient_var="hos_no", cluster_var="anno3.scvi",
  fixed_effects=c("g3","GEM")                 # edgeR 고정효과 경로
)
out2 <- milo_neighborhood_da_v3(
  sobj = data_seurat,
  target_var="g3", batch_var="GEM", patient_var="hos_no", cluster_var="anno3.scvi",
  fixed_effects=c("g3","GEM"), random_effects=c("hos_no"), # GLMM 경로
  use_future=TRUE, workers=16
)
}
