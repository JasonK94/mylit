% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/test_gpt.R
\name{milo_neighborhood_da_v2}
\alias{milo_neighborhood_da_v2}
\title{MILO neighborhood DA with fixed/random effects and fast counting}
\usage{
milo_neighborhood_da_v2(
  sobj,
  target_var = "g3",
  batch_var = "GEM",
  patient_var = "hos_no",
  cluster_var = "anno3.scvi",
  reduced_dim = "PCA",
  k = 30,
  d = 50,
  prop = 0.1,
  fixed_effects = NULL,
  random_effects = NULL,
  glmm_family = c("nb", "poisson"),
  p_adj_method = "BH",
  fdr_thresh = 0.1,
  logfc_thresh = 0.5,
  seed = 1,
  parallel_profile = c("auto", "rstudio", "terminal"),
  workers = max(1, parallel::detectCores() - 1)
)
}
\arguments{
\item{sobj}{Seurat object (uses \code{RNA} assay by default).}

\item{target_var}{Character. Group variable to compare (e.g., "g3").}

\item{batch_var}{Character. Batch factor (e.g., "GEM").}

\item{patient_var}{Character. Sample/pseudobulk unit (e.g., "hos_no").}

\item{cluster_var}{Character. Cluster labels (e.g., "anno3.scvi").}

\item{reduced_dim}{One of "PCA","UMAP","TSNE" to build graph on. Default "PCA".}

\item{k, d, prop}{Milo graph/neighborhood params.}

\item{fixed_effects}{Character vector. Defaults to c(target_var, batch_var).}

\item{random_effects}{Character vector. If length > 0, GLMM mode is used.}

\item{glmm_family}{"nb" or "poisson". Default "nb".}

\item{p_adj_method}{P value adjustment method. Default "BH".}

\item{fdr_thresh, logfc_thresh}{Thresholds for significance flags.}

\item{seed}{RNG seed.}

\item{parallel_profile}{One of c("auto","rstudio","terminal"). Passed to \code{set_parallel_profile()}.}

\item{workers}{Integer parallel workers for GLMM path.}
}
\value{
A list with components:
\item{mode}{ "edgeR_fixed_effects" or "glmm_random_effects" }
\item{milo}{ Milo object }
\item{da_nhood_with_cluster}{ per-neighborhood results }
\item{da_by_cluster}{ cluster-level summary }
}
\description{
Runs neighborhood-level differential abundance using MiloR. Provides two modes:
(A) edgeR GLM with spatial FDR (fixed effects only), or
(B) GLMM via glmmTMB with random effects (no spatial FDR; uses adj.p conservatively).
Also replaces \code{countCells()} by fast sparse multiplication for large data.
}
\examples{
set_parallel_profile("auto", workers=8, blas_threads=1)
out <- milo_neighborhood_da_v2(
  sobj = data_seurat,
  target_var="g3", batch_var="GEM", patient_var="hos_no", cluster_var="anno3.scvi",
  random_effects=c("hos_no")
)
}
