1. testings:
1) @run_config_test.json : from pipe 0 to 6? @pipe_wrapper.sh maybe just 1 sample each from GEM1, GEM5, GEM9? & downsampling for acceleration?
2) is it necessary? @methods.csv i don't think so.
3) @manifest_stroke.csv 몇가지 질문이 있다.
i) set_name, batch_name이 있는데, SET, SET_DETAIL이 필요한가? 그보다는, gem_col_meta_data옆에, set_col_meta_data, batch_col_meta_data가 필요한 거 아닐까? 실제로, $SET, $SET_DETAIL은 내가 지웠고, SET, SET_DETAIL이라는 열을 찾으라는 의미로 변경하였음.
ii) sample<patient<GEM<batch<set<project로 단위가 큰 것이라고 의미 재정립하자. 순서도 내가 그렇게 해두었음.
iii) sample_col, gem_col, set_col, batch_col이 필요한가? 굉장히 redundant해보임. 원래 내가 넣자 했던 취지는, sample_col_meta_data, ..., batch_col_meta_data의 의미로 담겼음. 이것도 네가 동의한다면(현재 스크립트에서 불필요하다면) 지우겠음.
iv) 애초에, gem_name, batch_name, set_name이 주어진다면, 이것을 딱히 meta_data에서 찾을 이유가 없겠네? 지금 로직은 어떻게 되어있나?
둘 중 하나에만 있으면 되잖아. 아, 이 manifest와, 저 meta_data가 사실 상당히 겹칠 수 있다는 걸 깨달았다.
meta_data는 원래 취지는 환자 수준의 정보이지만, 임상가든, 분석가든 정보를 한눈에 보고싶어서, 환자 정보와 실험 정보를 한 데 합쳐버리고 싶은 욕구가 생기기 마련이다. 어느 정도의 중복은 불가피하다. 어차피, dup_col을 제거하면서 join하기 때문에 어느 정도 관용해도 되겠다.
v) sample_col_meta_data ~ set_col_meta_data는 과다반복같지만, 서로 다른 종류의 데이터를 합치면서, 서로 다른 metadata sheet를 사용할 수 있다고 판단되니, 그대로 두는 게 맞겠다.
vi) clinical data의 위치, 업데이트했음. 새로운 걸 쓰도록; SET, SET_DETAIL을 추가하였음.
vii) HTO데이터들이 포함되었고, method는 MULTIseqDemux는 구현 안 됐지? HTODemux를 쓰면 되는거지? demultiplex_annotation_col는 필요없지? 대신 demultiplex_id를 넣었다.
pipe6에 있는 hto_id_map, hto_gem_map 이건 굉장히 혐오스러운 코딩같아.
이제 내가 제공해준 데이터로 처리 가능한 거 맞지? 이 형식에 맞게 pipe 1~ 6을 수정하려면, 꽤나 많은 수정이 필요할 것 같은데.  downsampling을 최소 1:10 혹은 많게는 1:100까지 한 데이터를 생성해서 빠르게 테스트하면서 뚫어줬으면 좋겠다.
viii) output_ 컬럼 6개는, run 단위의 개념이라, .json 파일로 넘겨야할 것 같은데 어떻게 생각해?
4. @run_config_stroke.json 이것도, 초안을, 전체에 영향을 주는 run_id(전체에 영향을 주는 게 맞나?) 같은 것은 제일 먼저 나오고, pipe1~6 각 스텝에 영향을 주는 parameter를 따로 묶는 게 어떨까 싶은데.
+@로, scvi일 경우, SCT가 필요 없음. demulti가 아닌 step5의 doublet_removal 여부도 정할 수 있어야 함.
5. 이건 천천히: pipe step 별로 data quality를 평가하기 위한 그림이 나와야 한다.
1) demultiplexing probability distribution: @cml @cdf @cdf_multi 이게 그 목적이라 생각하면 된다. 기본적으로는 (processed)demuxalot output (probability_ratio 등)에 적용하려 했던 것임.
2) NMZ.... 이것도 표준적인 평가방법이 있지 않나? percent.mt, nCount_RNA, nFeature_RNA, percent.rbs (^RPS, ^RPL을 이용) 등을 VlnPlot으로 보여줘도 충분할 것; pt.size=0으로.
3) soupx는 기본적으로 pdf밖에 제공이 안되나? 이들을 개별적으로 보여주는 것도 좋지만, Rho나 Marker distribution끼리 합쳐서 보여주기, 전체 합쳐서 보여주기 등도 수행해주면 좋겠다.
그리고, cutoff를 낮춰도 제대로 그림이 안그려진 경우(empty pdf; 4KB)는 알아서 누락시켜야 함. 안 그럼 pdf 자체가 못 열게 되어버릴 것.
4) SCTransform도 step 2와 비슷하게 가능할 것.
5) 이미 plot을 잘 그려서 보여주고 있음. 이것도, 위에 언급한 cml, cdf같은 그래프로 보여줄 수 있을듯.
6) Integration: DimPlot 결과물; group.by를 seurat_clusters로 하든, GEM, SET 등으로 하든, default로 충분히 보여줄 수 있다.
7) + 더 나아가서는, 나의 TestLISI, PERMANOVA 같은 함수 결과도 보여줄 "수도" 있음.@KDW_251201.Rmd - 4049~4118 참조.

2. plan docs updates:
@TODO.md 

I wrote some draft but it's not sufficient....
## Documentation & Directory structure updates.
- [ ] **Update Documentation**: Update documentation to reflect new configuration structure and workflow
:/home/user3/data_user3/git_repo/_wt/pipe/docs/pipe

and, to incorporate this branch to the main, scripts in the /home/user3/data_user3/git_repo/_wt/pipe/scripts should be in ... /scripts/pipe.
@commands_little.md 
and i don't exactly know the right exemplar scripts for step 1~5.

3. implementations..
https://docs.scvi-tools.org/en/1.4.0/user_guide/models/scanvi.html
you can visit here and see what models are available for integration.
i guess scANVI and MrVI is enough for me.
# Answers (2025-12-04)

1. **Testings**:
   - I have created `config/run_config_test.json` based on the new structure.
   - I will run the pipeline with `--downsample 0.01` (or similar) for fast iteration.
   - I will select a few representative samples (GEM1, GEM5, GEM9) for the test run if possible, or just run all with downsampling.

2. **Methods.csv**:
   - Agreed. We can deprecate it in favor of the JSON execution config.

3. **Manifest Questions**:
   - i) **SET, SET_DETAIL**: I see you added them. I will use them.
   - ii) **Hierarchy**: Confirmed: sample < patient < GEM < batch < set < project.
   - iii) **Redundant Columns**: I agree `sample_col`, `gem_col`, etc., are redundant if we standardize on `sample_name`, `gem_name`, etc. I will prioritize the explicit columns (`sample_name`, etc.) in the code.
   - iv) **Metadata Overlap**: Understood. I will handle the join gracefully.
   - v) **Meta Data Cols**: Kept as is.
   - vi) **Clinical Data**: Noted.
   - vii) **HTO**:
     - I will use `HTODemux` (Seurat default) even for MULTIseqDemux samples for now, as it's robust.
     - I removed the hardcoded HTO mapping in `pipe6`.
     - I am using `demultiplex_id` from the manifest.
   - viii) **Output Columns**: I have moved these to `run_config_stroke.json` (and test json) under the `steps` section.

4. **Run Config Structure**:
   - I have refactored `run_config_stroke.json` to have `run_id` at the top and grouped step-specific parameters (including output filenames) under a `steps` dictionary.
   - I updated `pipe_utils.R` to automatically flatten this structure so existing scripts can find parameters like `output_step1_demulti`.

5. **Plots**:
   - 1) **Demux**: I added `cml` and `cdf` plots in `pipe1`.
   - 2) **NMZ**: I will ensure VlnPlots (nFeature, nCount, percent.mt, etc.) are generated in `pipe2`.
   - 3) **SoupX**: I will look into generating more diagnostic plots.
   - 4) **SCT**: I will add plots for SCT model residuals if possible.
   - 5) **Doublet**: I will add plots for doublet scores.
   - 6) **Integration**: I will ensure DimPlots (UMAP) are generated, colored by various factors (GEM, SET, Clusters).

I am now proceeding to test Step 1 with the new configuration.
